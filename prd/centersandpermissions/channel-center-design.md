# 渠道中心 — 渠道与SP关系设计

> 本文档描述渠道中心中 **Channel 与 SP 的关系**，包括：外部 Channel 升级为 EX 内部 SP、SP 作为其他 SP 的 Channel 接入、以及各种场景下的处理逻辑。

---

## 1. 核心概念

### 1.1 两种渠道类型

| 类型 | 定义 | 能力来源 | API 对接 | 典型场景 |
|------|------|---------|---------|---------|
| **EX 内部 SP** | 已在 EX 注册为 SP 的服务商 | 自动同步自 SP 的产品定义 | EX 内部协议（自动） | BB 用 IPL 的发卡能力 |
| **外部 Channel** | 未在 EX 注册的第三方渠道 | 手动配置 | 外部 API 对接（手动） | 接入某银行/第三方支付 |

### 1.2 两种接入模式

| 模式 | 关系 | 商户信息 | 管理位置 | 典型场景 |
|------|------|---------|---------|---------|
| **代理模式** | TP 签约 SP 产品 | 推送商户信息给 SP，SP 为商户开户 | 产品中心（TP 视角） | 鲲鹏代理 IPL 收款 |
| **渠道模式** | SP 签约 Channel/SP 能力 | 不推送商户信息，底层透明 | 渠道中心（SP 视角） | BB 用 IPL 发卡能力 |

> **同一个服务商可以同时是"SP"和"Channel"**：在产品中心它是 SP（TP 可代理），在渠道中心它是另一个 SP 的 Channel（底层能力提供方）。

---

## 2. SP 作为 Channel 接入

### 2.1 场景

> BB（SP）签约 IPL（另一个 SP）的发卡能力，作为渠道合作，不是代理关系。

### 2.2 配置流程

```
1. BB 进入渠道中心 → 新增渠道
2. 选择渠道类型：EX 内部 SP
3. 选择 SP：IPL
4. 系统自动拉取 IPL 的产品能力（只读展示）：
   - ✅ 发卡 - USD/EUR/GBP
   - ✅ 收款 - USD/EUR
5. BB 只需配置增量信息：
   - 成本费率（BB 和 IPL 的商务协议）
   - 协议有效期
   - 路由优先级/权重
6. API 对接：EX 内部协议，自动完成，无需手动配置
7. 完成 → IPL 成为 BB 的一个渠道
```

### 2.3 配置项说明

| 配置项 | 来源 | 是否需要手动配置 | 说明 |
|--------|------|:---------------:|------|
| 渠道能力（币种/支付方式/限额） | 自动同步自 SP 产品定义 | ❌ 只读 | SP 产品变更时自动同步 |
| 成本费率 | 商务协议 | ✅ 手动 | BB 和 IPL 的渠道成本 |
| 协议/有效期 | 商务协议 | ✅ 手动 | 渠道合作协议管理 |
| 路由优先级/权重 | BB 自身策略 | ✅ 手动 | 决定交易优先走哪个渠道 |
| API 对接配置 | EX 内部协议 | ❌ 自动 | 内部 SP 走内部通道 |

### 2.4 能力同步机制

- **实时同步**：当 IPL 在产品中心更新产品能力时，BB 渠道中心的 IPL 渠道能力自动更新
- **变更通知**：能力变更时通知 BB 运营（如 IPL 新增了 GBP 发卡能力）
- **不可超范围**：BB 路由到 IPL 的交易不能超出 IPL 的产品能力范围

---

## 3. 外部 Channel 升级为 EX 内部 SP

### 3.1 场景

> X 服务商最初作为外部 Channel 被 BB 接入（手动配置能力和 API），后来 X 在 EX 注册为 SP 并上架了产品。

### 3.2 升级触发

```
触发条件：
  - X 在 EX 完成 SP 注册并上架产品
  - 系统检测到渠道中心已存在 X 的 Channel 记录（通过机构标识匹配）

触发方式：
  - 系统自动检测 → 在渠道中心提示升级
  - 或运营手动触发升级
```

### 3.3 升级流程

```
┌──────────────────────────────────────────────────────┐
│  ⚠️ 渠道升级提示                                      │
│                                                       │
│  检测到渠道 "X服务商" 已注册为 EX 内部 SP。             │
│  是否将该渠道从"外部 Channel"升级为"EX 内部 SP"？       │
│                                                       │
│  升级后：                                              │
│  ✅ 渠道能力将自动同步自 X 的产品定义                    │
│  ✅ API 对接将切换为 EX 内部协议                        │
│  ✅ 成本费率、路由规则等商务配置保留不变                  │
│  ✅ 历史订单数据保留并关联                               │
│                                                       │
│  [确认升级]    [暂不升级]                                │
└──────────────────────────────────────────────────────┘
```

### 3.4 升级处理逻辑

| 配置项 | 升级前（外部 Channel） | 升级后（EX 内部 SP） | 处理方式 |
|--------|:---------------------:|:-------------------:|---------|
| **渠道类型** | 外部 Channel | EX 内部 SP | 🔄 替换 |
| **渠道能力** | 手动配置 | 自动同步自 SP 产品定义 | 🔄 替换（以 SP 产品为准） |
| **API 对接** | 外部协议（密钥/证书/回调） | EX 内部协议 | 🔄 替换（内部 SP 走内部通道） |
| **成本费率** | 手动配置 | 手动配置 | ✅ 保留（商务条款不变） |
| **路由规则** | 已配置 | 已配置 | ✅ 保留（路由策略不变） |
| **协议/有效期** | 手动配置 | 手动配置 | ✅ 保留（可能需要更新） |
| **历史订单** | Channel 订单 | 关联到 SP | ✅ 保留（订单记录不丢失） |

### 3.5 升级后的能力差异处理

升级时可能出现能力不一致：

| 情况 | 处理方式 |
|------|---------|
| SP 产品能力 ≥ 原 Channel 能力 | 正常升级，新增能力自动可用 |
| SP 产品能力 < 原 Channel 能力 | 提示运营：部分原有能力在 SP 产品中不存在，确认是否继续 |
| SP 产品能力与原 Channel 能力完全不同 | 建议保留为外部 Channel，不升级 |

### 3.6 "暂不升级"的场景

有些情况下可能选择不升级：

- X 虽然注册了 SP，但 BB 和 X 的合作走的是独立商务协议，不走 EX 内部结算
- X 的 SP 产品能力还不完整，外部 Channel 的能力配置更准确
- 正在迁移过渡期，需要新旧并行

---

## 4. EX 内部 SP 降级为外部 Channel

### 4.1 场景

> SP Y 退出 EX 平台（注销 SP 身份），但 BB 仍需要使用 Y 的支付能力。

### 4.2 降级流程

```
触发条件：
  - Y 在 EX 注销 SP 身份
  - 系统检测到渠道中心有 SP 类型的 Y 渠道记录

处理流程：
  1. 系统通知 BB 运营：Y 已注销 SP，渠道能力将无法自动同步
  2. 运营选择：
     a) 降级为外部 Channel → 手动补充能力配置和 API 对接
     b) 停用该渠道 → 调整路由规则，将交易切到其他渠道
  3. 如选择降级：
     - 渠道类型变更为"外部 Channel"
     - 最后一次同步的能力配置保留（变为可编辑）
     - 需要手动配置 API 对接（密钥/证书/回调）
     - 成本费率、路由规则保留
```

---

## 5. 完整生命周期

```
                    ┌─────────────┐
                    │  外部 Channel │
                    │  （手动配置）  │
                    └──────┬──────┘
                           │
                    注册为 EX SP │ 升级
                           ▼
                    ┌─────────────┐
                    │ EX 内部 SP   │
                    │（能力自动同步）│
                    └──────┬──────┘
                           │
                    注销 SP │ 降级
                           ▼
                    ┌─────────────┐
                    │  外部 Channel │
                    │  （手动配置）  │
                    └─────────────┘
```

### 各阶段对比

| 阶段 | 渠道类型 | 能力配置 | API 对接 | 成本费率 | 路由规则 |
|------|---------|---------|---------|---------|---------|
| **初始接入（Channel）** | 外部 Channel | 手动 | 手动 | 手动 | 手动 |
| **升级为 SP** | EX 内部 SP | 自动同步 | 自动 | 保留 | 保留 |
| **降级为 Channel** | 外部 Channel | 保留（变可编辑） | 需重新配置 | 保留 | 保留 |

---

## 6. 同一服务商的双身份并存

### 6.1 场景

> X 服务商在 EX 注册为 SP 并上架了产品。同时：
> - 鲲鹏（TP）在产品中心代理 X 的产品（代理模式）
> - BB（SP）在渠道中心把 X 配置为渠道（渠道模式）

### 6.2 两种身份对比

```
                        X 服务商
                       /         \
                      /           \
            产品中心（SP身份）    渠道中心（Channel身份）
                |                      |
          上架产品给 TP 代理      提供底层能力给其他 SP
                |                      |
          鲲鹏签约代理 X 产品    BB 把 X 配为渠道
                |                      |
          推送商户信息给 X       不推送商户，BB 自己处理
```

### 6.3 数据隔离

| 维度 | 产品中心（SP 身份） | 渠道中心（Channel 身份） |
|------|-------------------|----------------------|
| **管理者** | X 自己管理产品上架 | BB 管理渠道配置 |
| **费率** | 商户费率（卖价） | 渠道成本（买价） |
| **商户** | X 直接服务商户 | X 不感知 BB 的商户 |
| **订单** | X 的商户订单 | BB 路由到 X 的渠道订单 |
| **结算** | X 和商户结算 | BB 和 X 渠道结算 |

---

## 7. 产品中心 vs 渠道中心 边界

| 维度 | 产品中心 | 渠道中心 |
|------|---------|---------|
| **谁在用** | TP（签约代理）+ SP（上架产品） | SP（配置渠道） |
| **管什么** | "卖什么产品给商户" | "有什么渠道能力来交付" |
| **签约对象** | TP ↔ SP（代理关系） | SP ↔ Channel/SP（渠道合作） |
| **商户信息** | 推送给 SP | 不推送，底层透明 |
| **费率含义** | 商户费率（卖价） | 渠道成本（买价） |
| **能力关系** | 产品能力 ≤ 渠道能力 | 渠道能力 = 实际交付能力 |
| **类比** | 淘宝的"商品管理" | 淘宝的"供应商管理" |

> **产品上架时，系统校验：产品要求的能力 ≤ 渠道实际能力。**
> 即：你不能卖一个你的渠道交付不了的产品。
