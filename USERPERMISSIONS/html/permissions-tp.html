<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TP ç§Ÿæˆ·ç«¯ â€” Users & Permissions</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
    --pri:#4f46e5;--pri-light:#eef2ff;--pri-dark:#4338ca;
    --green:#16a34a;--green-bg:#dcfce7;--red:#dc2626;--red-bg:#fef2f2;
    --amber:#d97706;--amber-bg:#fefce8;--blue:#2563eb;--blue-bg:#eff6ff;
    --text:#1e293b;--text2:#475569;--text3:#94a3b8;
    --bg:#f8fafc;--card:#fff;--border:#e2e8f0;--border-light:#f1f5f9;
    --radius:8px;--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;}

/* Topbar */
.topbar-main{display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:56px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
.topbar-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);}
.topbar-logo .mark{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,var(--pri));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:12px;}
.topbar-logo .brand{font-weight:700;font-size:15px;}
.topbar-right{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2);}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--pri);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;}

.content{max-width:1100px;margin:0 auto;padding:28px 32px 100px;}

/* Page header */
.page-header{margin-bottom:24px;}
.page-title{font-size:22px;font-weight:700;margin-bottom:4px;}
.page-sub{font-size:13px;color:var(--text2);}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:24px;}
.tab{padding:10px 24px;font-size:14px;font-weight:600;color:var(--text3);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;font-family:inherit;}
.tab:hover{color:var(--text2);}
.tab.on{color:var(--pri);border-bottom-color:var(--pri);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Card */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px;box-shadow:var(--shadow);}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-size:15px;font-weight:700;}

/* Table */
.tbl{width:100%;border-collapse:collapse;}
.tbl th{text-align:left;font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;padding:10px 14px;border-bottom:2px solid var(--border);background:var(--bg);}
.tbl td{padding:12px 14px;font-size:13px;color:var(--text2);border-bottom:1px solid var(--border-light);vertical-align:middle;}
.tbl tr:hover td{background:#fafbfc;}
.tbl .nm{font-weight:600;color:var(--text);}

/* Badge */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;}
.badge-green{background:var(--green-bg);color:var(--green);}
.badge-amber{background:var(--amber-bg);color:var(--amber);}
.badge-red{background:var(--red-bg);color:var(--red);}
.badge-gray{background:var(--border-light);color:var(--text3);}
.badge-blue{background:var(--blue-bg);color:var(--blue);}

/* Buttons */
.btn{padding:7px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text2);font-family:inherit;transition:all .15s;white-space:nowrap;}
.btn:hover{border-color:var(--pri);color:var(--pri);}
.btn-pri{background:var(--pri);color:#fff;border-color:var(--pri);}
.btn-pri:hover{background:var(--pri-dark);border-color:var(--pri-dark);color:#fff;}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-danger{color:var(--red);border-color:rgba(220,38,38,.3);}
.btn-danger:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}
.btn-ghost{border:none;background:none;padding:5px 10px;}
.btn-ghost:hover{background:var(--bg);}

/* Modal */
.modal-mask{display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);z-index:200;align-items:center;justify-content:center;}
.modal-mask.show{display:flex;}
.modal{background:var(--card);border-radius:16px;padding:28px 32px;width:560px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.15);}
.modal-lg{width:640px;}
.modal h2{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal .m-sub{font-size:13px;color:var(--text2);margin-bottom:16px;}

/* Form */
.fg{margin-bottom:14px;}
.fl{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:5px;}
.fl .req{color:var(--red);}
.fi{width:100%;padding:9px 14px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-family:inherit;color:var(--text);outline:none;transition:border-color .15s;}
.fi:focus{border-color:var(--pri);box-shadow:0 0 0 3px var(--pri-light);}
.fi-hint{font-size:11px;color:var(--text3);margin-top:4px;}

/* Permission grid */
.perm-grid{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.perm-header{display:grid;grid-template-columns:1fr 80px 80px 80px;background:var(--bg);border-bottom:2px solid var(--border);}
.perm-header span{padding:8px 12px;font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.3px;text-align:center;}
.perm-header span:first-child{text-align:left;}
.perm-row{display:grid;grid-template-columns:1fr 80px 80px 80px;border-bottom:1px solid var(--border-light);align-items:center;}
.perm-row:last-child{border-bottom:none;}
.perm-row:hover{background:#fafbfc;}
.perm-row .perm-name{padding:10px 12px;font-size:13px;font-weight:500;color:var(--text);}
.perm-row .perm-cb{text-align:center;padding:10px 0;}
.perm-row .perm-cb input{width:16px;height:16px;cursor:pointer;accent-color:var(--pri);}

/* Role card */
.role-card{border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:10px;transition:all .15s;}
.role-card:hover{border-color:var(--pri);box-shadow:0 0 0 3px var(--pri-light);}
.role-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.role-card-name{font-size:14px;font-weight:700;color:var(--text);}
.role-card-desc{font-size:12px;color:var(--text3);margin-bottom:8px;}
.role-card-perms{display:flex;flex-wrap:wrap;gap:4px;}
.role-card-perm{padding:2px 8px;background:var(--bg);border:1px solid var(--border);border-radius:10px;font-size:11px;color:var(--text2);}
.role-card-users{font-size:11px;color:var(--text3);margin-top:6px;}

/* Alert */
.alert{padding:12px 16px;border-radius:var(--radius);font-size:13px;line-height:1.6;display:flex;gap:10px;align-items:flex-start;margin-bottom:16px;}
.alert-info{background:var(--pri-light);color:#3730a3;border:1px solid #c7d2fe;}
.alert-warn{background:#fef3c7;color:#92400e;border:1px solid #fde68a;}

/* Btn row */
.btn-row{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}

/* Search bar */
.search-bar{display:flex;gap:10px;margin-bottom:16px;}
.search-input{flex:1;max-width:320px;}

/* Toast */
.toast{position:fixed;top:70px;right:24px;padding:10px 20px;border-radius:var(--radius);font-size:13px;font-weight:500;color:#fff;background:var(--green);z-index:300;transform:translateX(calc(100% + 40px));transition:transform .25s ease;box-shadow:0 4px 12px rgba(0,0,0,.12);}
.toast.show{transform:translateX(0);}
.toast.err{background:var(--red);}

</style>
</head>
<body>

<!-- ===== Topbar ===== -->
<div class="topbar-main">
    <a class="topbar-logo" href="#">
        <div class="mark">TP</div>
        <span class="brand">Tenant Portal</span>
    </a>
    <div class="topbar-right">
        <span>admin@fulunited.com</span>
        <div class="avatar">AD</div>
    </div>
</div>

<div class="content">
        <div class="page-header">
            <div class="page-title">Users & Permissions</div>
            <div class="page-sub">ç®¡ç†ç§Ÿæˆ·ç”¨æˆ·è´¦å·å’Œè§’è‰²æƒé™</div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab on" onclick="switchTab('users',this)">ğŸ‘¥ Users</button>
            <button class="tab" onclick="switchTab('roles',this)">ğŸ›¡ï¸ Roles</button>
        </div>

        <!-- ===== Users Tab ===== -->
        <div class="tab-panel active" id="panelUsers">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Users</div>
                    <button class="btn btn-pri btn-sm" onclick="openCreateUser()">+ Create User</button>
                </div>
                <table class="tbl">
                    <thead><tr><th>Name</th><th>Email</th><th>Roles</th><th>Status</th><th>Last Login</th><th></th></tr></thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ===== Roles Tab ===== -->
        <div class="tab-panel" id="panelRoles">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Roles</div>
                    <button class="btn btn-pri btn-sm" onclick="openCreateRole()">+ Create Role</button>
                </div>
                <div id="rolesContainer"></div>
            </div>
    </div>
</div>

<!-- ===== Modals ===== -->

<!-- Create / Edit User -->
<div class="modal-mask" id="modalUser">
    <div class="modal">
        <h2 id="userModalTitle">Create User</h2>
        <div class="m-sub" id="userModalSub">åˆ›å»ºæ–°ç”¨æˆ·ï¼Œç³»ç»Ÿå°†å‘é€ä¸´æ—¶å¯†ç åˆ°ç”¨æˆ·é‚®ç®±</div>

        <div class="fg">
            <label class="fl">Name <span class="req">*</span></label>
            <input class="fi" id="userName" placeholder="e.g. Zhang San">
        </div>

        <div class="fg">
            <label class="fl">Email <span class="req">*</span></label>
            <input class="fi" id="userEmail" type="email" placeholder="e.g. zhangsan@company.com">
            <div class="fi-hint">ç”¨äºç™»å½•å’Œå¯†ç æ‰¾å›ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹</div>
        </div>

        <div class="fg" id="userRolesGroup">
            <label class="fl">Roles <span class="req">*</span></label>
            <div id="userRoleCheckboxes"></div>
        </div>

        <div class="btn-row">
            <button class="btn" onclick="closeModal('modalUser')">Cancel</button>
            <button class="btn btn-pri" id="userSaveBtn" onclick="saveUser()">Create User</button>
        </div>
    </div>
</div>

<!-- Create / Edit Role -->
<div class="modal-mask" id="modalRole">
    <div class="modal modal-lg">
        <h2 id="roleModalTitle">Create Role</h2>
        <div class="m-sub" id="roleModalSub">å®šä¹‰è§’è‰²åç§°å’Œæƒé™èŒƒå›´</div>

        <div class="fg">
            <label class="fl">Role Name <span class="req">*</span></label>
            <input class="fi" id="roleName" placeholder="e.g. å®¢æˆ·ç»ç†">
        </div>

        <div class="fg">
            <label class="fl">Description</label>
            <input class="fi" id="roleDesc" placeholder="e.g. è´Ÿè´£å•†æˆ·å…¥é©»å’Œå®¢æˆ·ç®¡ç†">
        </div>

        <div class="fg">
            <label class="fl">Permissions <span class="req">*</span></label>
            <div class="perm-grid" id="permGrid">
                <div class="perm-header">
                    <span>Module</span>
                    <span>View</span>
                    <span>Operate</span>
                    <span>Export</span>
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn" onclick="closeModal('modalRole')">Cancel</button>
            <button class="btn btn-pri" id="roleSaveBtn" onclick="saveRole()">Create Role</button>
        </div>
    </div>
</div>

<!-- Confirm dialog -->
<div class="modal-mask" id="modalConfirm">
    <div class="modal" style="width:400px;">
        <h2 id="confirmTitle">Confirm</h2>
        <div class="m-sub" id="confirmMsg"></div>
        <div class="btn-row">
            <button class="btn" onclick="closeModal('modalConfirm')">Cancel</button>
            <button class="btn btn-danger" id="confirmBtn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>

<!-- User Created Success -->
<div class="modal-mask" id="modalUserCreated">
    <div class="modal" style="width:460px;">
        <h2>âœ… User Created</h2>
        <div class="m-sub">ç”¨æˆ·è´¦å·å·²åˆ›å»ºï¼Œä¸´æ—¶å¯†ç å·²å‘é€åˆ°ç”¨æˆ·é‚®ç®±ã€‚</div>

        <div class="alert alert-info">
            <span>ğŸ“§</span>
            <div>
                ç³»ç»Ÿå·²å‘é€é‚®ä»¶åˆ° <b id="createdEmail"></b>ï¼ŒåŒ…å«ï¼š<br>
                Â· ç™»å½•åœ°å€<br>
                Â· ä¸´æ—¶å¯†ç <br>
                Â· é¦–æ¬¡ç™»å½•éœ€ä¿®æ”¹å¯†ç çš„æç¤º
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-pri" onclick="closeModal('modalUserCreated')">Done</button>
        </div>
    </div>
</div>

<!-- Demo bar -->
<div style="position:fixed;bottom:0;left:0;right:0;background:#1e293b;color:#e2e8f0;padding:10px 20px;z-index:400;display:flex;align-items:center;gap:16px;font-size:12px;">
    <span style="font-weight:700;color:#f59e0b;">DEMO</span>
    <span style="color:#94a3b8;">Click tabs to switch between Users and Roles. All actions are interactive demos. Login/Activation flows see tp-login.html.</span>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ===== Data ===== */
const tpModules = [
    { id:'product', name:'Product Center' },
    { id:'customer', name:'Customer Center' },
    { id:'settlement', name:'Settlement Center' },
    { id:'channel', name:'Channel Center' },
    { id:'treasury', name:'Treasury Center' },
    { id:'compliance', name:'Compliance & Risk' },
    { id:'reports', name:'Reports' },
    { id:'settings', name:'Settings' },
];

let roles = [
    { id:'r0', name:'Admin', desc:'ç§Ÿæˆ·ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆç³»ç»Ÿå†…ç½®ï¼Œä¸å¯ç¼–è¾‘ï¼‰', isAdmin:true, perms:{product:'voe',customer:'voe',settlement:'voe',channel:'voe',treasury:'voe',compliance:'voe',reports:'voe',settings:'voe'} },
    { id:'r1', name:'å®¢æˆ·ç»ç†', desc:'è´Ÿè´£å•†æˆ·å…¥é©»å’Œå®¢æˆ·ç®¡ç†', isAdmin:false, perms:{customer:'voe',compliance:'v',reports:'ve'} },
    { id:'r2', name:'æ¸…ç®—è¿è¥', desc:'è´Ÿè´£æ¸…ç®—å’Œå¯¹è´¦', isAdmin:false, perms:{settlement:'voe',channel:'v',treasury:'v',reports:'ve'} },
    { id:'r3', name:'é£æ§ä¸“å‘˜', desc:'è´Ÿè´£åˆè§„å’Œé£æ§ç®¡ç†', isAdmin:false, perms:{customer:'v',compliance:'voe',reports:'ve'} },
];

let users = [
    { id:'u1', name:'Admin', email:'admin@fulunited.com', roles:['r0'], status:'active', lastLogin:'2 hours ago', isAdmin:true },
    { id:'u2', name:'Li Wei', email:'liwei@fulunited.com', roles:['r1'], status:'active', lastLogin:'1 day ago', isAdmin:false },
    { id:'u3', name:'Zhang Fang', email:'zhangfang@fulunited.com', roles:['r2','r3'], status:'active', lastLogin:'3 hours ago', isAdmin:false },
    { id:'u4', name:'Wang Jun', email:'wangjun@fulunited.com', roles:['r1'], status:'pending', lastLogin:'â€”', isAdmin:false },
    { id:'u5', name:'Chen Mei', email:'chenmei@fulunited.com', roles:['r3'], status:'disabled', lastLogin:'30 days ago', isAdmin:false },
];

let nextUserId = 6;
let nextRoleId = 4;
let editingUserId = null;
let editingRoleId = null;
let pendingConfirm = null;

/* ===== Tab ===== */
function switchTab(tab, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    btn.classList.add('on');
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(tab === 'users' ? 'panelUsers' : 'panelRoles').classList.add('active');
    if (tab === 'roles') renderRoles();
}

/* ===== Modal ===== */
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

/* ===== Toast ===== */
function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type === 'err' ? 'err' : '') + ' show';
    setTimeout(() => t.classList.remove('show'), 2500);
}

/* ===== Helpers ===== */
function getRoleName(rid) {
    const r = roles.find(x => x.id === rid);
    return r ? r.name : rid;
}

function permLabel(p) {
    const map = { v:'View', o:'Operate', e:'Export' };
    return p.split('').map(c => map[c] || c).join(', ');
}

/* ===== Users ===== */
function renderUsers() {
    const tbody = document.getElementById('usersBody');
    tbody.innerHTML = users.map(u => {
        const statusBadge = u.status === 'active' ? '<span class="badge badge-green">Active</span>' :
            u.status === 'pending' ? '<span class="badge badge-amber">Pending</span>' :
            '<span class="badge badge-gray">Disabled</span>';
        const roleNames = u.roles.map(getRoleName).join(', ');
        const actions = u.isAdmin ? '<span style="font-size:11px;color:var(--text3);">System Admin</span>' :
            `<button class="btn btn-sm btn-ghost" onclick="openEditUser('${u.id}')">Edit</button>` +
            (u.status === 'disabled' ?
                `<button class="btn btn-sm btn-ghost" onclick="toggleUser('${u.id}','enable')">Enable</button>` :
                `<button class="btn btn-sm btn-ghost" onclick="toggleUser('${u.id}','disable')">Disable</button>`) +
            (u.status === 'pending' ? `<button class="btn btn-sm btn-ghost" onclick="resendPassword('${u.id}')">Resend</button>` : '') +
            `<button class="btn btn-sm btn-ghost btn-danger" onclick="confirmDeleteUser('${u.id}')">Delete</button>`;
        return `<tr>
            <td class="nm">${u.name}${u.isAdmin ? ' <span class="badge badge-blue">Admin</span>' : ''}</td>
            <td>${u.email}</td>
            <td>${roleNames}</td>
            <td>${statusBadge}</td>
            <td style="font-size:12px;color:var(--text3);">${u.lastLogin}</td>
            <td style="white-space:nowrap;">${actions}</td>
        </tr>`;
    }).join('');
}

function openCreateUser() {
    editingUserId = null;
    document.getElementById('userModalTitle').textContent = 'Create User';
    document.getElementById('userModalSub').textContent = 'åˆ›å»ºæ–°ç”¨æˆ·ï¼Œç³»ç»Ÿå°†å‘é€ä¸´æ—¶å¯†ç åˆ°ç”¨æˆ·é‚®ç®±';
    document.getElementById('userSaveBtn').textContent = 'Create User';
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userEmail').disabled = false;
    buildUserRoleCheckboxes([]);
    openModal('modalUser');
}

function openEditUser(uid) {
    const u = users.find(x => x.id === uid);
    if (!u) return;
    editingUserId = uid;
    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('userModalSub').textContent = 'ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²åˆ†é…';
    document.getElementById('userSaveBtn').textContent = 'Save Changes';
    document.getElementById('userName').value = u.name;
    document.getElementById('userEmail').value = u.email;
    document.getElementById('userEmail').disabled = true;
    buildUserRoleCheckboxes(u.roles);
    openModal('modalUser');
}

function buildUserRoleCheckboxes(selected) {
    const container = document.getElementById('userRoleCheckboxes');
    container.innerHTML = roles.filter(r => !r.isAdmin).map(r => {
        const checked = selected.includes(r.id) ? 'checked' : '';
        return `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:13px;cursor:pointer;">
            <input type="checkbox" value="${r.id}" ${checked} style="accent-color:var(--pri);width:16px;height:16px;">
            <span style="font-weight:500;">${r.name}</span>
            <span style="color:var(--text3);font-size:11px;">${r.desc}</span>
        </label>`;
    }).join('');
}

function saveUser() {
    const name = document.getElementById('userName').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    if (!name) { showToast('Please enter a name', 'err'); return; }
    if (!email || !email.includes('@')) { showToast('Please enter a valid email', 'err'); return; }

    const selectedRoles = [];
    document.querySelectorAll('#userRoleCheckboxes input:checked').forEach(cb => selectedRoles.push(cb.value));
    if (!selectedRoles.length) { showToast('Please select at least one role', 'err'); return; }

    if (editingUserId) {
        const u = users.find(x => x.id === editingUserId);
        if (u) { u.name = name; u.roles = selectedRoles; }
        closeModal('modalUser');
        renderUsers();
        showToast('User updated');
    } else {
        // check duplicate email
        if (users.some(u => u.email === email)) { showToast('Email already exists', 'err'); return; }
        const uid = 'u' + (nextUserId++);
        users.push({ id:uid, name, email, roles:selectedRoles, status:'pending', lastLogin:'â€”', isAdmin:false });
        closeModal('modalUser');
        renderUsers();
        document.getElementById('createdEmail').textContent = email;
        openModal('modalUserCreated');
    }
}

function toggleUser(uid, action) {
    const u = users.find(x => x.id === uid);
    if (!u) return;
    u.status = action === 'enable' ? 'active' : 'disabled';
    renderUsers();
    showToast(action === 'enable' ? 'User enabled' : 'User disabled');
}

function resendPassword(uid) {
    const u = users.find(x => x.id === uid);
    if (!u) return;
    showToast('Temporary password resent to ' + u.email);
}

function confirmDeleteUser(uid) {
    const u = users.find(x => x.id === uid);
    if (!u) return;
    document.getElementById('confirmTitle').textContent = 'Delete User';
    document.getElementById('confirmMsg').textContent = `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${u.name}" (${u.email})ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
    document.getElementById('confirmBtn').textContent = 'Delete';
    pendingConfirm = () => {
        users = users.filter(x => x.id !== uid);
        renderUsers();
        showToast('User deleted');
    };
    openModal('modalConfirm');
}

function confirmAction() {
    closeModal('modalConfirm');
    if (pendingConfirm) { pendingConfirm(); pendingConfirm = null; }
}

/* ===== Roles ===== */
function renderRoles() {
    const container = document.getElementById('rolesContainer');
    container.innerHTML = roles.map(r => {
        const permTags = Object.entries(r.perms).map(([mod, p]) => {
            const modName = tpModules.find(m => m.id === mod)?.name || mod;
            return `<span class="role-card-perm">${modName}: ${permLabel(p)}</span>`;
        }).join('');
        const userCount = users.filter(u => u.roles.includes(r.id)).length;
        const actions = r.isAdmin ?
            '<span style="font-size:11px;color:var(--text3);">System Role</span>' :
            `<button class="btn btn-sm btn-ghost" onclick="openEditRole('${r.id}')">Edit</button>
             <button class="btn btn-sm btn-ghost btn-danger" onclick="confirmDeleteRole('${r.id}')">Delete</button>`;
        return `<div class="role-card">
            <div class="role-card-header">
                <div class="role-card-name">${r.name}${r.isAdmin ? ' <span class="badge badge-blue">Built-in</span>' : ''}</div>
                <div>${actions}</div>
            </div>
            <div class="role-card-desc">${r.desc}</div>
            <div class="role-card-perms">${permTags}</div>
            <div class="role-card-users">ğŸ‘¥ ${userCount} user${userCount !== 1 ? 's' : ''} assigned</div>
        </div>`;
    }).join('');
}

function buildPermGrid(perms) {
    const grid = document.getElementById('permGrid');
    // keep header, remove rows
    grid.querySelectorAll('.perm-row').forEach(r => r.remove());
    tpModules.forEach(m => {
        const p = perms ? (perms[m.id] || '') : '';
        const row = document.createElement('div');
        row.className = 'perm-row';
        row.innerHTML = `
            <div class="perm-name">${m.name}</div>
            <div class="perm-cb"><input type="checkbox" data-mod="${m.id}" data-perm="v" ${p.includes('v')?'checked':''}></div>
            <div class="perm-cb"><input type="checkbox" data-mod="${m.id}" data-perm="o" ${p.includes('o')?'checked':''} onchange="autoView(this)"></div>
            <div class="perm-cb"><input type="checkbox" data-mod="${m.id}" data-perm="e" ${p.includes('e')?'checked':''} onchange="autoView(this)"></div>
        `;
        grid.appendChild(row);
    });
}

function autoView(cb) {
    if (cb.checked) {
        const mod = cb.dataset.mod;
        const viewCb = document.querySelector(`input[data-mod="${mod}"][data-perm="v"]`);
        if (viewCb) viewCb.checked = true;
    }
}

function openCreateRole() {
    editingRoleId = null;
    document.getElementById('roleModalTitle').textContent = 'Create Role';
    document.getElementById('roleModalSub').textContent = 'å®šä¹‰è§’è‰²åç§°å’Œæƒé™èŒƒå›´';
    document.getElementById('roleSaveBtn').textContent = 'Create Role';
    document.getElementById('roleName').value = '';
    document.getElementById('roleDesc').value = '';
    buildPermGrid(null);
    openModal('modalRole');
}

function openEditRole(rid) {
    const r = roles.find(x => x.id === rid);
    if (!r || r.isAdmin) return;
    editingRoleId = rid;
    document.getElementById('roleModalTitle').textContent = 'Edit Role';
    document.getElementById('roleModalSub').textContent = 'ä¿®æ”¹è§’è‰²åç§°å’Œæƒé™èŒƒå›´';
    document.getElementById('roleSaveBtn').textContent = 'Save Changes';
    document.getElementById('roleName').value = r.name;
    document.getElementById('roleDesc').value = r.desc;
    buildPermGrid(r.perms);
    openModal('modalRole');
}

function saveRole() {
    const name = document.getElementById('roleName').value.trim();
    if (!name) { showToast('Please enter a role name', 'err'); return; }

    const perms = {};
    tpModules.forEach(m => {
        let p = '';
        if (document.querySelector(`input[data-mod="${m.id}"][data-perm="v"]`)?.checked) p += 'v';
        if (document.querySelector(`input[data-mod="${m.id}"][data-perm="o"]`)?.checked) p += 'o';
        if (document.querySelector(`input[data-mod="${m.id}"][data-perm="e"]`)?.checked) p += 'e';
        if (p) perms[m.id] = p;
    });

    if (!Object.keys(perms).length) { showToast('Please select at least one permission', 'err'); return; }

    const desc = document.getElementById('roleDesc').value.trim();

    if (editingRoleId) {
        const r = roles.find(x => x.id === editingRoleId);
        if (r) { r.name = name; r.desc = desc; r.perms = perms; }
        closeModal('modalRole');
        renderRoles();
        showToast('Role updated');
    } else {
        const rid = 'r' + (nextRoleId++);
        roles.push({ id:rid, name, desc, isAdmin:false, perms });
        closeModal('modalRole');
        renderRoles();
        showToast('Role created');
    }
}

function confirmDeleteRole(rid) {
    const r = roles.find(x => x.id === rid);
    if (!r) return;
    const userCount = users.filter(u => u.roles.includes(rid)).length;
    document.getElementById('confirmTitle').textContent = 'Delete Role';
    document.getElementById('confirmMsg').textContent = userCount > 0 ?
        `è§’è‰² "${r.name}" å½“å‰æœ‰ ${userCount} ä¸ªç”¨æˆ·ä½¿ç”¨ï¼Œåˆ é™¤åè¿™äº›ç”¨æˆ·å°†å¤±å»è¯¥è§’è‰²çš„æƒé™ã€‚ç¡®å®šåˆ é™¤ï¼Ÿ` :
        `ç¡®å®šè¦åˆ é™¤è§’è‰² "${r.name}"ï¼Ÿ`;
    document.getElementById('confirmBtn').textContent = 'Delete';
    pendingConfirm = () => {
        roles = roles.filter(x => x.id !== rid);
        users.forEach(u => { u.roles = u.roles.filter(r => r !== rid); });
        renderRoles();
        renderUsers();
        showToast('Role deleted');
    };
    openModal('modalConfirm');
}

/* ===== Init ===== */
renderUsers();
renderRoles();
</script>
</body>
</html>
