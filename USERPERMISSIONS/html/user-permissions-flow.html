<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EX - Permission System End-to-End Flow</title>
<style>
:root {
    --pri: #5b6cf5; --pri-h: #4a5ae0; --pri-l: #eef0ff;
    --bg: #f5f7fa; --white: #fff; --border: #e2e8f0; --border-l: #f1f3f5;
    --t1: #1a202c; --t2: #4a5568; --t3: #a0aec0;
    --ok: #10b981; --ok-bg: #d1fae5; --ok-t: #065f46;
    --warn: #f59e0b; --warn-bg: #fef3c7; --warn-t: #92400e;
    --err: #ef4444; --err-bg: #fee2e2; --err-t: #991b1b;
    --info: #3b82f6; --info-bg: #dbeafe; --info-t: #1e40af;
    --r: 8px; --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'PingFang SC', sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--t1); -webkit-font-smoothing: antialiased; }

/* === Top Bar === */
.topbar { background: var(--white); border-bottom: 1px solid var(--border); height: 52px; display: flex; align-items: center; padding: 0 28px; position: sticky; top: 0; z-index: 100; }
.topbar-logo { font-size: 15px; font-weight: 700; color: var(--pri); display: flex; align-items: center; gap: 8px; }
.topbar-logo svg { flex-shrink: 0; }
.topbar-mid { margin-left: 32px; font-size: 13px; color: var(--t2); }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.topbar-user { display: flex; align-items: center; gap: 8px; padding: 4px 12px 4px 4px; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--t2); cursor: default; }
.topbar-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--pri); color: #fff; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; }

/* === Progress Rail === */
.rail { background: var(--white); border-bottom: 1px solid var(--border); padding: 16px 28px; display: flex; align-items: center; gap: 0; overflow-x: auto; }
.rail-step { display: flex; align-items: center; gap: 0; white-space: nowrap; }
.rail-dot { width: 30px; height: 30px; border-radius: 50%; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; background: #edf2f7; color: var(--t3); flex-shrink: 0; cursor: pointer; transition: all .15s; border: 2px solid transparent; }
.rail-dot:hover { border-color: #cbd5e0; }
.rail-dot.active { background: var(--pri); color: #fff; border-color: var(--pri); }
.rail-dot.done { background: var(--ok); color: #fff; border-color: var(--ok); }
.rail-label { font-size: 11px; color: var(--t3); margin-left: 6px; margin-right: 6px; }
.rail-label.active { color: var(--t1); font-weight: 600; }
.rail-label.done { color: var(--ok-t); }
.rail-bar { width: 32px; height: 2px; background: #edf2f7; flex-shrink: 0; margin: 0 2px; }
.rail-bar.done { background: var(--ok); }

/* === Page === */
.page { display: none; max-width: 820px; margin: 0 auto; padding: 28px 20px 60px; }
.page.on { display: block; }
.page h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
.page .subtitle { font-size: 14px; color: var(--t3); margin-bottom: 24px; line-height: 1.5; }

/* === Card === */
.card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); padding: 20px 24px; margin-bottom: 16px; }
.card-title { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
.card-desc { font-size: 13px; color: var(--t3); margin-bottom: 14px; line-height: 1.5; }

/* === Form === */
.fg { margin-bottom: 16px; }
.fl { display: block; font-size: 13px; font-weight: 500; color: var(--t2); margin-bottom: 5px; }
.fi { width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; color: var(--t1); background: var(--white); outline: none; transition: border-color .15s, box-shadow .15s; font-family: var(--font); }
.fi:focus { border-color: var(--pri); box-shadow: 0 0 0 3px rgba(91,108,245,.1); }
.fi::placeholder { color: #cbd5e0; }
.fi-hint { font-size: 12px; color: var(--t3); margin-top: 4px; line-height: 1.4; }
.fi-row { display: flex; gap: 8px; }
.fi-row .fi { flex: 1; }
select.fi { cursor: pointer; }

/* === Buttons === */
.btn { padding: 9px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .15s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-family: var(--font); }
.btn-pri { background: var(--pri); color: #fff; }
.btn-pri:hover { background: var(--pri-h); }
.btn-sec { background: var(--white); color: var(--t2); border: 1px solid var(--border); }
.btn-sec:hover { background: var(--bg); }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-ghost { background: none; color: var(--pri); padding: 6px 10px; font-size: 13px; }
.btn-ghost:hover { background: var(--pri-l); }
.btn-full { width: 100%; }
.btn-bar { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }

/* === Badge === */
.badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
.b-ok { background: var(--ok-bg); color: var(--ok-t); }
.b-warn { background: var(--warn-bg); color: var(--warn-t); }
.b-err { background: var(--err-bg); color: var(--err-t); }
.b-pri { background: var(--pri-l); color: var(--pri); }
.b-info { background: var(--info-bg); color: var(--info-t); }
.b-muted { background: #f1f3f5; color: var(--t3); }

/* === Alert === */
.alert { padding: 12px 16px; border-radius: var(--r); font-size: 13px; line-height: 1.6; margin-bottom: 16px; display: flex; gap: 10px; align-items: flex-start; }
.alert-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.a-info { background: var(--info-bg); color: var(--info-t); border: 1px solid #93c5fd; }
.a-warn { background: var(--warn-bg); color: var(--warn-t); border: 1px solid #fcd34d; }
.a-ok { background: var(--ok-bg); color: var(--ok-t); border: 1px solid #6ee7b7; }

/* === Toggle === */
.tg-group { display: flex; gap: 6px; flex-wrap: wrap; }
.tg { padding: 7px 14px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-weight: 500; color: var(--t2); background: var(--white); cursor: pointer; transition: all .15s; user-select: none; }
.tg:hover { border-color: #cbd5e0; }
.tg.on { border-color: var(--pri); background: var(--pri-l); color: var(--pri); }

/* === Checkbox Grid === */
.ck-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.ck-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--t2); transition: all .12s; user-select: none; position: relative; }
.ck-item:hover { border-color: #cbd5e0; }
.ck-item.on { border-color: var(--pri); background: var(--pri-l); color: var(--pri); }
.ck-box { width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: transparent; flex-shrink: 0; transition: all .12s; }
.ck-item.on .ck-box { background: var(--pri); border-color: var(--pri); color: #fff; }
.ck-group-label { font-size: 11px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .5px; padding: 8px 0 4px; grid-column: 1 / -1; }
.ck-label { flex: 1; }
/* === Operation Level Toggle === */
.ck-op { display: none; margin-left: auto; flex-shrink: 0; }
.ck-item.on .ck-op { display: flex; }
.ck-op-btn { padding: 2px 8px; font-size: 10px; font-weight: 600; border: 1px solid var(--border); background: var(--white); color: var(--t3); border-radius: 4px; cursor: pointer; transition: all .12s; white-space: nowrap; }
.ck-op-btn:first-child { border-radius: 4px 0 0 4px; border-right: none; }
.ck-op-btn:last-child { border-radius: 0 4px 4px 0; }
.ck-op-btn.active { background: var(--pri); color: #fff; border-color: var(--pri); }
.ck-op-btn:hover:not(.active) { background: var(--bg); color: var(--t2); }
/* Review tag with op level */
.tag-with-op { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
.tag-with-op .op-label { font-size: 9px; padding: 1px 5px; border-radius: 8px; font-weight: 600; }
.op-view { background: var(--warn-bg); color: var(--warn-t); }
.op-operate { background: var(--ok-bg); color: var(--ok-t); }

/* === Table === */
.tbl { width: 100%; border-collapse: collapse; }
.tbl th { text-align: left; font-size: 11px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .4px; padding: 8px; border-bottom: 1px solid var(--border); }
.tbl td { padding: 12px 8px; font-size: 13px; color: var(--t2); border-bottom: 1px solid var(--border-l); vertical-align: middle; }
.tbl .nm { font-weight: 500; color: var(--t1); }
.tbl .sub { font-size: 11px; color: var(--t3); }
.tbl .ctr { text-align: center; }

/* === Perm Badge (clickable) === */
.pb { display: inline-flex; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all .12s; user-select: none; }
.pb:hover { transform: scale(1.05); }
.pb-self { background: var(--ok-bg); color: var(--ok-t); }
.pb-owner { background: var(--err-bg); color: var(--err-t); }
.pb-all { background: var(--ok-bg); color: var(--ok-t); }
.pb-own { background: var(--warn-bg); color: var(--warn-t); }
.pb-na { background: #f1f3f5; color: var(--t3); cursor: default; }

/* === Info Row === */
.irow { display: flex; padding: 12px 0; border-bottom: 1px solid var(--border-l); }
.irow:last-child { border-bottom: none; }
.irow-k { width: 140px; font-size: 13px; font-weight: 500; color: var(--t3); flex-shrink: 0; }
.irow-v { flex: 1; font-size: 14px; color: var(--t2); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

/* === Tag List === */
.tags { display: flex; flex-wrap: wrap; gap: 4px; }
.tag { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }

/* === Toast === */
.toast { position: fixed; top: 60px; right: 20px; padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 500; color: #fff; z-index: 9999; transform: translateX(calc(100% + 40px)); transition: transform .25s ease; box-shadow: 0 4px 12px rgba(0,0,0,.12); }
.toast.show { transform: translateX(0); }

/* === Overlay / Modal === */
.ov { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.3); backdrop-filter: blur(2px); z-index: 500; align-items: center; justify-content: center; }
.ov.show { display: flex; }
.modal { background: var(--white); border-radius: 12px; padding: 28px; width: 100%; max-width: 480px; box-shadow: 0 8px 24px rgba(0,0,0,.12); position: relative; animation: fadeUp .2s ease; max-height: 90vh; overflow-y: auto; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.modal-x { position: absolute; top: 14px; right: 14px; width: 28px; height: 28px; border: none; background: var(--bg); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--t3); }
.modal-x:hover { background: #e2e8f0; }
.modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
.modal .mdesc { font-size: 13px; color: var(--t3); margin-bottom: 18px; line-height: 1.5; }

/* === Misc === */
.sep { height: 1px; background: var(--border-l); margin: 16px 0; }
.center { text-align: center; }
.mt-8 { margin-top: 8px; } .mt-12 { margin-top: 12px; } .mt-16 { margin-top: 16px; } .mt-20 { margin-top: 20px; } .mt-24 { margin-top: 24px; }
.mb-8 { margin-bottom: 8px; } .mb-16 { margin-bottom: 16px; }
.muted { color: var(--t3); }
.small { font-size: 12px; }
.flex-b { display: flex; align-items: center; justify-content: space-between; }
.link { color: var(--pri); font-weight: 500; cursor: pointer; text-decoration: none; font-size: 13px; }
.link:hover { text-decoration: underline; }
.highlight-box { background: var(--bg); border-radius: var(--r); padding: 14px 16px; margin-bottom: 14px; }
.role-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }

/* === Account Switcher Dropdown === */
.topbar-user { position: relative; cursor: pointer; }
.acct-dropdown { display: none; position: absolute; top: calc(100% + 8px); right: 0; width: 380px; background: var(--white); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,.12); z-index: 200; overflow: hidden; }
.acct-dropdown.show { display: block; }
.acct-dd-header { padding: 14px 18px; border-bottom: 1px solid var(--border-l); display: flex; align-items: center; justify-content: space-between; }
.acct-dd-header h4 { font-size: 14px; font-weight: 600; }
.acct-dd-list { padding: 8px; max-height: 340px; overflow-y: auto; }
.acct-dd-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all .12s; position: relative; }
.acct-dd-item:hover { background: var(--bg); }
.acct-dd-item.current { background: var(--pri-l); border: 1px solid rgba(91,108,245,.2); }
.acct-dd-item .acct-avatar { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: #fff; flex-shrink: 0; }
.acct-dd-item .acct-info { flex: 1; min-width: 0; }
.acct-dd-item .acct-name { font-size: 13px; font-weight: 600; color: var(--t1); display: flex; align-items: center; gap: 6px; }
.acct-dd-item .acct-mid { font-size: 11px; color: var(--t3); }
.acct-dd-item .acct-badges { display: flex; gap: 4px; margin-top: 3px; }
.acct-dd-actions { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
.acct-star { width: 28px; height: 28px; border-radius: 6px; border: none; background: transparent; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all .12s; color: var(--t3); }
.acct-star:hover { background: var(--warn-bg); color: var(--warn); }
.acct-star.default { color: var(--warn); }
.acct-switch-btn { padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--white); font-size: 11px; font-weight: 600; color: var(--pri); cursor: pointer; transition: all .12s; }
.acct-switch-btn:hover { background: var(--pri-l); border-color: var(--pri); }
.acct-dd-item.current .acct-switch-btn { background: var(--pri); color: #fff; border-color: var(--pri); cursor: default; }
.acct-dd-footer { padding: 10px 18px; border-top: 1px solid var(--border-l); display: flex; align-items: center; justify-content: space-between; }
.owner-crown { display: inline-flex; align-items: center; gap: 3px; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 600; background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 1px solid #fcd34d; }
.owner-type-badge { display: inline-flex; align-items: center; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 500; background: var(--warn-bg); color: var(--warn-t); }

/* === Accounts Settings Page === */
.acct-settings-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; margin-bottom: 16px; }
.acct-settings-header { padding: 18px 24px; border-bottom: 1px solid var(--border-l); }
.acct-settings-header h3 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
.acct-settings-header p { font-size: 13px; color: var(--t3); }
.acct-settings-table { width: 100%; border-collapse: collapse; }
.acct-settings-table th { text-align: left; font-size: 11px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .4px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--bg); }
.acct-settings-table td { padding: 14px 20px; border-bottom: 1px solid var(--border-l); vertical-align: middle; }
.acct-settings-table tr:last-child td { border-bottom: none; }
.acct-settings-table tr:hover td { background: #fafbfc; }
.acct-name-cell { display: flex; align-items: center; gap: 12px; }
.acct-name-cell .acct-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 600; color: #fff; flex-shrink: 0; }
.acct-name-cell .acct-text .name { font-size: 14px; font-weight: 600; color: var(--t1); }
.acct-name-cell .acct-text .mid { font-size: 11px; color: var(--t3); font-family: monospace; }
.default-star-lg { font-size: 18px; cursor: pointer; color: var(--t3); transition: all .15s; }
.default-star-lg:hover { color: var(--warn); transform: scale(1.15); }
.default-star-lg.active { color: var(--warn); }

/* Settings tabs */
.settings-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
.settings-tab { padding: 10px 20px; font-size: 14px; font-weight: 500; color: var(--t3); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; transition: all .15s; }
.settings-tab:hover { color: var(--t2); }
.settings-tab.active { color: var(--t1); border-bottom-color: var(--pri); font-weight: 600; }

/* Owner definition card */
.owner-def-card { background: var(--bg); border-radius: var(--r); padding: 20px 24px; }
.owner-def-card h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.owner-def-card .def-desc { font-size: 12px; color: var(--t3); margin-bottom: 14px; }
.owner-def-item { display: flex; align-items: center; gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border-l); }
.owner-def-item:last-child { border-bottom: none; }
.owner-def-item .def-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--pri-l); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.owner-def-item .def-title { font-size: 13px; font-weight: 600; color: var(--pri); }
.owner-def-item .def-sub { font-size: 12px; color: var(--t3); }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
    <div class="topbar-logo">
        <svg width="24" height="24" viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="#5b6cf5"/><path d="M16 8L22 12V20L16 24L10 20V12L16 8Z" fill="white"/></svg>
        EX Platform
    </div>
    <div class="topbar-mid">ABC Trading (MID-001) Â· Permission Management</div>
    <div class="topbar-right">
        <div class="topbar-user" onclick="toggleAcctDropdown(event)">
            <div class="topbar-avatar">å¼ </div>
            <span id="topbarAcctName">å¼ ä¸‰ Â· ABC Trading</span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="margin-left:2px;"><path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>

            <!-- Account Switcher Dropdown -->
            <div class="acct-dropdown" id="acctDropdown">
                <div class="acct-dd-header">
                    <h4>Your accounts</h4>
                    <span class="link" onclick="event.stopPropagation(); goStep(6);">Settings â†’</span>
                </div>
                <div class="acct-dd-list" id="acctDdList">
                    <!-- filled by JS -->
                </div>
                <div class="acct-dd-footer">
                    <span style="font-size:11px; color:var(--t3);">â­ = Default account (auto-login)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Rail -->
<div class="rail" id="rail">
    <div class="rail-step">
        <div class="rail-dot active" onclick="goStep(0)">1</div>
        <div class="rail-label active">Configure Role</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(1)">2</div>
        <div class="rail-label">Menu & Operations</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(2)">3</div>
        <div class="rail-label">Data Access</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(3)">4</div>
        <div class="rail-label">Invite User</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(4)">5</div>
        <div class="rail-label">User Registers</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(5)">6</div>
        <div class="rail-label">Review & Modify</div>
    </div>
    <div class="rail-bar"></div>
    <div class="rail-step">
        <div class="rail-dot" onclick="goStep(6)">7</div>
        <div class="rail-label">Accounts</div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ==================== STEP 0: Configure Role ==================== -->
<div class="page on" id="step-0">
    <h2>Step 1: Configure Role</h2>
    <p class="subtitle">As Owner of ABC Trading, you create a new role or use a preset. Roles define what a user can see and do.</p>

    <div class="card">
        <div class="card-title">Existing roles</div>
        <div class="card-desc">These roles already exist in your MID. You can create a new one or edit existing.</div>
        <table class="tbl">
            <thead><tr><th>Role</th><th>Type</th><th>Members</th><th></th></tr></thead>
            <tbody>
                <tr>
                    <td><div class="nm">Owner</div><div class="sub">å¼€æˆ·äºº/æ³•äºº/è‘£äº‹</div></td>
                    <td><span class="badge b-warn">System</span></td>
                    <td>1 (å¼ ä¸‰)</td>
                    <td class="muted">â€”</td>
                </tr>
                <tr>
                    <td><div class="nm">ç®¡ç†å‘˜</div><div class="sub">Full menu access, no member mgmt</div></td>
                    <td><span class="badge b-pri">Preset</span></td>
                    <td>0</td>
                    <td><span class="link" onclick="loadPreset('ç®¡ç†å‘˜')">Edit</span></td>
                </tr>
                <tr>
                    <td><div class="nm">è´¢åŠ¡</div><div class="sub">Assets, Transactions, Reports</div></td>
                    <td><span class="badge b-pri">Preset</span></td>
                    <td>0</td>
                    <td><span class="link" onclick="loadPreset('è´¢åŠ¡')">Edit</span></td>
                </tr>
                <tr>
                    <td><div class="nm">è¿è¥</div><div class="sub">Transfer In, Checkout, Cards</div></td>
                    <td><span class="badge b-pri">Preset</span></td>
                    <td>0</td>
                    <td><span class="link" onclick="loadPreset('è¿è¥')">Edit</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card" style="border: 2px dashed var(--pri); background: var(--pri-l);">
        <div class="card-title" style="color:var(--pri);">Create new role</div>
        <div class="card-desc">Or start from scratch with a custom role.</div>
        <div class="fg">
            <label class="fl">Role name</label>
            <input class="fi" id="roleName" placeholder="e.g. é«˜çº§è¿è¥, å®¡æ ¸å‘˜..." value="é«˜çº§è´¢åŠ¡">
        </div>
        <div class="fg">
            <label class="fl">Base template (optional)</label>
            <div class="tg-group">
                <div class="tg" onclick="pickBase(this,'none')">From scratch</div>
                <div class="tg on" onclick="pickBase(this,'è´¢åŠ¡')">Based on è´¢åŠ¡</div>
                <div class="tg" onclick="pickBase(this,'è¿è¥')">Based on è¿è¥</div>
                <div class="tg" onclick="pickBase(this,'ç®¡ç†å‘˜')">Based on ç®¡ç†å‘˜</div>
            </div>
        </div>
        <div class="btn-bar">
            <button class="btn btn-pri" onclick="createRole()">Create & configure permissions â†’</button>
        </div>
    </div>
</div>

<!-- ==================== STEP 1: Menu & Operation Permissions ==================== -->
<div class="page" id="step-1">
    <h2>Step 2: Menu & Operation Permissions</h2>
    <p class="subtitle">Configure which menus <strong id="s1RoleName">é«˜çº§è´¢åŠ¡</strong> can see, and how sensitive operations are verified.</p>

    <div class="card">
        <div class="card-title">Menu access & operation level</div>
        <div class="card-desc">Check the menus this role can access. For each enabled menu, choose <strong>ä»…æŸ¥é˜…</strong> (View Only) or <strong>å¯æ“ä½œ</strong> (Operable).</div>
        <div class="ck-grid" id="menuGrid">
            <div class="ck-group-label">ASSETS</div>
            <div class="ck-item on" data-menu="Fiat Accounts" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Fiat Accounts</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Crypto Wallet" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Crypto Wallet</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Exchange" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Exchange</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>

            <div class="ck-group-label">TRANSFER IN</div>
            <div class="ck-item" data-menu="Collection Tools" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Collection Tools</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Remitter" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Remitter</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Payins" data-op="view" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Payins</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn active" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Crypto Receive" data-op="view" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Crypto Receive</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn active" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>

            <div class="ck-group-label">CHECKOUT</div>
            <div class="ck-item" data-menu="Online Payment" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Online Payment</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Invoice" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Invoice</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Subscription" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Subscription</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>

            <div class="ck-group-label">TRANSFER OUT</div>
            <div class="ck-item on" data-menu="Beneficiary" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Beneficiary</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Payouts" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Payouts</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Crypto Send" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Crypto Send</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Remittance Orders" data-op="view" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Remittance Orders</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn active" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>

            <div class="ck-group-label">CARDS</div>
            <div class="ck-item" data-menu="Cards Management" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Cards Management</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Card Transactions" data-op="view" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Card Transactions</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn active" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>

            <div class="ck-group-label">OTHER</div>
            <div class="ck-item on" data-menu="Reports" data-op="view" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Reports</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn active" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item on" data-menu="Trade Documents" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Trade Documents</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Developer" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Developer (API)</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
            <div class="ck-item" data-menu="Settings" data-op="operate" onclick="ckToggle(this)"><div class="ck-box">âœ“</div><span class="ck-label">Settings</span><div class="ck-op" onclick="event.stopPropagation()"><button class="ck-op-btn" onclick="setMenuOp(this,'view')">ä»…æŸ¥é˜…</button><button class="ck-op-btn active" onclick="setMenuOp(this,'operate')">å¯æ“ä½œ</button></div></div>
        </div>
        <div class="fi-hint mt-8"><strong>ä»…æŸ¥é˜…</strong> = åªèƒ½æŸ¥çœ‹åˆ—è¡¨å’Œè¯¦æƒ…ï¼Œä¸èƒ½æ–°å»º/ç¼–è¾‘/åˆ é™¤ã€‚<strong>å¯æ“ä½œ</strong> = å¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼ˆå—å…¶ä»–æƒé™çº¦æŸï¼‰ã€‚</div>
    </div>

    <div class="card">
        <div class="card-title">Operation permissions (default for this role)</div>
        <div class="card-desc">When a user with this role performs sensitive operations, how should they be verified? Click to toggle Self â†” Owner.</div>
        <table class="tbl">
            <thead><tr><th>Operation category</th><th>Description</th><th class="ctr">Default</th></tr></thead>
            <tbody>
                <tr>
                    <td class="nm">Initiate transaction</td>
                    <td class="sub">Payins, Payouts, Crypto Send/Receive, Exchange, Remittance</td>
                    <td class="ctr"><span class="pb pb-self" onclick="togglePB(this)">Self</span></td>
                </tr>
                <tr>
                    <td class="nm">Fund operations</td>
                    <td class="sub">Deposit, Withdrawal, Internal transfer, Card top-up</td>
                    <td class="ctr"><span class="pb pb-owner" onclick="togglePB(this)">Owner</span></td>
                </tr>
                <tr>
                    <td class="nm">Merchant config</td>
                    <td class="sub">Webhooks, API keys, Notifications, Company profile</td>
                    <td class="ctr"><span class="pb pb-owner" onclick="togglePB(this)">Owner</span></td>
                </tr>
            </tbody>
        </table>
        <div class="fi-hint mt-8"><strong>Self</strong> = user verifies with own credential. <strong>Owner</strong> = code sent to Owner's mobile. Owner can override per-user later.</div>
    </div>

    <div class="btn-bar">
        <button class="btn btn-sec" onclick="goStep(0)">â† Back</button>
        <button class="btn btn-pri" onclick="saveMenuOps()">Save & configure data access â†’</button>
    </div>
</div>

<!-- ==================== STEP 2: Data Access ==================== -->
<div class="page" id="step-2">
    <h2>Step 3: Data Access</h2>
    <p class="subtitle">Configure whether <strong id="s2RoleName">é«˜çº§è´¢åŠ¡</strong> sees all data or only data assigned to them, per module.</p>

    <div class="alert a-info">
        <span class="alert-icon">ğŸ’¡</span>
        <div>
            <strong>All</strong> = sees all data in this module. <strong>Own</strong> = only sees data assigned to / created by this user.<br>
            Only modules with menu access are shown. Click badges to toggle.
        </div>
    </div>

    <div class="card">
        <div class="card-title">Data visibility per module</div>
        <div class="card-desc">Modules without menu access are automatically hidden.</div>
        <table class="tbl" id="dataTable">
            <thead><tr><th>Module</th><th class="ctr">Data scope</th></tr></thead>
            <tbody id="dataBody">
                <!-- filled by JS -->
            </tbody>
        </table>
    </div>

    <div class="card" style="background:var(--bg);border:none;">
        <div style="font-size:13px;color:var(--t2);line-height:1.7;">
            <strong>Data assignment rules:</strong><br>
            â€¢ <strong>Unassigned data</strong> is visible to everyone with menu access<br>
            â€¢ Data <strong>created by a user</strong> is auto-assigned to that user<br>
            â€¢ Owner/ç®¡ç†å‘˜ can assign data from each module's list page<br>
            â€¢ Related data follows: e.g., assigning a Collection Tool also assigns its Payins<br>
            â€¢ <strong>Region-based filtering</strong>: planned for future release (not this version)
        </div>
    </div>

    <div class="btn-bar">
        <button class="btn btn-sec" onclick="goStep(1)">â† Back</button>
        <button class="btn btn-pri" onclick="saveDataAccess()">Save role & invite user â†’</button>
    </div>
</div>

<!-- ==================== STEP 3: Invite User ==================== -->
<div class="page" id="step-3">
    <h2>Step 4: Invite User</h2>
    <p class="subtitle">Send an invitation to a new user. You can assign one or multiple roles.</p>

    <div class="card">
        <div class="card-title">Role created successfully!</div>
        <div class="card-desc">Your new role is ready. Now invite someone to use it.</div>
        <div class="highlight-box" id="roleSummaryBox">
            <!-- filled by JS -->
        </div>
    </div>

    <div class="card">
        <div class="card-title">Invite a new member</div>
        <div class="card-desc">Enter their email or mobile. They'll receive an invitation link.</div>

        <div class="fg">
            <label class="fl">Invite via</label>
            <div class="tg-group">
                <div class="tg on" id="invEmail" onclick="setInvMethod('email')">ğŸ“§ Email</div>
                <div class="tg" id="invMobile" onclick="setInvMethod('mobile')">ğŸ“± Mobile</div>
            </div>
        </div>

        <div class="fg" id="invEmailFg">
            <label class="fl">Email address</label>
            <input class="fi" id="invAddress" placeholder="user@example.com" value="wang@newuser.com">
        </div>
        <div class="fg" id="invMobileFg" style="display:none;">
            <label class="fl">Mobile number</label>
            <div class="fi-row">
                <select class="fi" style="width:100px;"><option>ğŸ‡¨ğŸ‡³ +86</option><option>ğŸ‡­ğŸ‡° +852</option><option>ğŸ‡ºğŸ‡¸ +1</option></select>
                <input class="fi" placeholder="Phone number">
            </div>
        </div>

        <div class="fg">
            <label class="fl">Assign roles (can select multiple)</label>
            <div class="tg-group" id="roleAssignGroup">
                <!-- filled by JS -->
            </div>
            <div class="fi-hint mt-8">This user will have the combined permissions of all selected roles.</div>
        </div>

        <div class="alert a-info">
            <span class="alert-icon">ğŸ”’</span>
            <div>
                <strong>Invitation rules:</strong><br>
                â€¢ Link expires in <strong>7 days</strong>, can only be used <strong>once</strong><br>
                â€¢ If email is not registered â†’ user will be guided to register first<br>
                â€¢ If email is already registered â†’ user logs in to accept<br>
                â€¢ New member defaults to <strong>Owner verification</strong> for all operations<br>
                â€¢ Owner is notified when invitation is accepted
            </div>
        </div>
    </div>

    <div class="btn-bar">
        <button class="btn btn-sec" onclick="goStep(2)">â† Back</button>
        <button class="btn btn-pri" onclick="sendInvite()">Send invitation â†’</button>
    </div>
</div>

<!-- ==================== STEP 4: User Registers ==================== -->
<div class="page" id="step-4">
    <h2>Step 5: User Receives Invitation & Registers</h2>
    <p class="subtitle">Switching perspective: now we are <strong>ç‹äº” (wang@newuser.com)</strong>, the invited user.</p>

    <!-- Sub-step A: Email received -->
    <div id="s4a">
        <div class="card" style="border-left: 3px solid var(--pri);">
            <div style="font-size:12px;color:var(--t3);margin-bottom:8px;">ğŸ“§ Email received by wang@newuser.com</div>
            <div style="background:var(--bg);border-radius:var(--r);padding:16px;">
                <div style="font-size:11px;color:var(--t3);">From: EX Platform &lt;noreply@ex.com&gt;</div>
                <div style="font-size:16px;font-weight:600;margin:8px 0;">You've been invited to join ABC Trading</div>
                <div style="font-size:13px;color:var(--t2);line-height:1.6;">
                    å¼ ä¸‰ has invited you to join <strong>ABC Trading</strong> on EX Platform.<br>
                    Your role: <strong id="s4RoleNames">é«˜çº§è´¢åŠ¡</strong><br><br>
                    Click below to accept the invitation.
                </div>
                <button class="btn btn-pri btn-sm mt-12" onclick="s4GoRegister()">Accept invitation â†’</button>
            </div>
        </div>
    </div>

    <!-- Sub-step B: Not registered, create account -->
    <div id="s4b" style="display:none;">
        <div class="alert a-warn">
            <span class="alert-icon">âš ï¸</span>
            <div><strong>No account found</strong> for wang@newuser.com. Create an account to join ABC Trading.</div>
        </div>
        <div class="card">
            <div class="card-title">Create your account</div>
            <div class="card-desc">Register to accept the invitation.</div>
            <div class="fg">
                <label class="fl">Email</label>
                <input class="fi" value="wang@newuser.com" disabled style="background:var(--bg);">
                <div class="fi-hint">Pre-filled from invitation</div>
            </div>
            <div class="fg">
                <label class="fl">Set password</label>
                <input class="fi" type="password" placeholder="At least 8 characters" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="fg">
                <label class="fl">Verification code</label>
                <div class="fi-row">
                    <input class="fi" placeholder="6-digit code" value="382916">
                    <button class="btn btn-sec btn-sm" onclick="showToast('Code sent to wang@newuser.com','info')">Send code</button>
                </div>
            </div>
            <div class="alert a-info" style="margin-bottom:14px;">
                <span class="alert-icon">ğŸ’¡</span>
                <div>Already have an account? <span class="link" onclick="showToast('Redirecting to login...','info')">Sign in with existing account</span></div>
            </div>
            <button class="btn btn-pri btn-full" onclick="s4Complete()">Create account & join ABC Trading</button>
        </div>
    </div>

    <!-- Sub-step C: Success -->
    <div id="s4c" style="display:none;">
        <div class="card">
            <div class="center">
                <div style="font-size:48px;margin-bottom:12px;">ğŸ‰</div>
                <h2>Welcome to ABC Trading!</h2>
                <p class="muted mt-8" style="font-size:14px;">You have joined as <strong id="s4JoinedRoles">é«˜çº§è´¢åŠ¡</strong>.</p>
            </div>
            <div class="highlight-box mt-16" id="s4AccessSummary">
                <!-- filled by JS -->
            </div>
            <div class="alert a-info mt-12">
                <span class="alert-icon">ğŸ”’</span>
                <div>All sensitive operations require <strong>Owner verification</strong> by default. The Owner can authorize you to use Self verification later.</div>
            </div>
            <div class="btn-bar" style="justify-content:center;">
                <button class="btn btn-pri" onclick="goStep(5)">Continue â†’ Owner reviews permissions</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== STEP 5: Review & Modify ==================== -->
<div class="page" id="step-5">
    <h2>Step 6: Review & Modify User Permissions</h2>
    <p class="subtitle">Back to <strong>Owner (å¼ ä¸‰)</strong> perspective. View ç‹äº”'s full permission details and make changes.</p>

    <div class="card">
        <div class="flex-b mb-16">
            <div>
                <div class="card-title">User: ç‹äº”</div>
                <div class="card-desc" style="margin-bottom:0;">wang@newuser.com Â· Joined just now</div>
            </div>
            <span class="badge b-ok">Active</span>
        </div>

        <div class="irow">
            <div class="irow-k">Roles</div>
            <div class="irow-v" id="reviewRoles">
                <!-- filled by JS -->
            </div>
        </div>
        <div class="irow">
            <div class="irow-k">Portal</div>
            <div class="irow-v">Merchant Portal (MP)</div>
        </div>
        <div class="irow">
            <div class="irow-k">MID</div>
            <div class="irow-v">ABC Trading (MID-001)</div>
        </div>
        <div class="irow">
            <div class="irow-k">Invited by</div>
            <div class="irow-v">å¼ ä¸‰ (Owner)</div>
        </div>
    </div>

    <!-- Menu Access Review -->
    <div class="card">
        <div class="flex-b mb-8">
            <div class="card-title">Menu access</div>
            <button class="btn btn-ghost btn-sm" onclick="openModal('mEditMenu')">Edit</button>
        </div>
        <div class="card-desc">Menus this user can see (combined from all assigned roles).</div>
        <div class="tags" id="reviewMenus">
            <!-- filled by JS -->
        </div>
    </div>

    <!-- Operation Permissions Review -->
    <div class="card">
        <div class="flex-b mb-8">
            <div class="card-title">Operation permissions</div>
            <button class="btn btn-ghost btn-sm" onclick="openModal('mEditOps')">Edit</button>
        </div>
        <div class="card-desc">How sensitive operations are verified for this user. Owner can override role defaults.</div>
        <table class="tbl" id="reviewOpsTable">
            <thead><tr><th>Operation</th><th class="ctr">Role default</th><th class="ctr">User override</th></tr></thead>
            <tbody id="reviewOpsBody">
                <!-- filled by JS -->
            </tbody>
        </table>
    </div>

    <!-- Data Access Review -->
    <div class="card">
        <div class="flex-b mb-8">
            <div class="card-title">Data access</div>
            <button class="btn btn-ghost btn-sm" onclick="openModal('mEditData')">Edit</button>
        </div>
        <div class="card-desc">What data this user can see in each module.</div>
        <table class="tbl" id="reviewDataTable">
            <thead><tr><th>Module</th><th class="ctr">Scope</th></tr></thead>
            <tbody id="reviewDataBody">
                <!-- filled by JS -->
            </tbody>
        </table>
    </div>

    <!-- Change Role -->
    <div class="card">
        <div class="flex-b mb-8">
            <div class="card-title">Change roles</div>
        </div>
        <div class="card-desc">Add or remove roles for this user. Permissions update immediately.</div>
        <div class="tg-group" id="reviewRoleToggles">
            <!-- filled by JS -->
        </div>
        <div class="fi-hint mt-8">Changing roles will update menu access and default operation permissions. Data access and per-user overrides are preserved.</div>
    </div>

    <div class="card" style="border-color:var(--err);border-style:dashed;">
        <div class="flex-b">
            <div>
                <div class="card-title" style="color:var(--err);">Remove user</div>
                <div class="card-desc" style="margin-bottom:0;">Remove ç‹äº” from ABC Trading. They will lose all access.</div>
            </div>
            <button class="btn btn-sm" style="background:var(--err-bg);color:var(--err);border:1px solid #fca5a5;" onclick="showToast('User removed from ABC Trading','err')">Remove</button>
        </div>
    </div>

    <div class="btn-bar" style="justify-content:center;">
        <button class="btn btn-pri" onclick="goStep(6)">View account switcher â†’</button>
        <button class="btn btn-sec" onclick="goStep(0);showToast('Flow complete! Start over from Step 1.','ok')">â†» Start over</button>
    </div>
</div>

<!-- ==================== STEP 6: Account Switcher & Settings ==================== -->
<div class="page" id="step-6">
    <h2>Step 7: Account Switcher & Settings</h2>
    <p class="subtitle">User <strong>å¼ ä¸‰</strong> has multiple accounts (MIDs). They can set a default, switch between accounts, and see Owner status.</p>

    <!-- Settings Tabs -->
    <div class="settings-tabs">
        <button class="settings-tab" onclick="switchSettingsTab('profile')">Profile</button>
        <button class="settings-tab" onclick="switchSettingsTab('security')">Security</button>
        <button class="settings-tab active" onclick="switchSettingsTab('accounts')" id="tabAccounts">Accounts</button>
        <button class="settings-tab" onclick="switchSettingsTab('permissions')">Permissions</button>
    </div>

    <!-- Accounts Table -->
    <div class="acct-settings-card">
        <div class="acct-settings-header">
            <h3>Your accounts</h3>
            <p>View your associated accounts and roles. Click â­ to set default account for auto-login.</p>
        </div>
        <table class="acct-settings-table">
            <thead>
                <tr>
                    <th>Account Name</th>
                    <th>Role</th>
                    <th>Owner Type</th>
                    <th style="text-align:center;">Default</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="acctSettingsBody">
                <!-- filled by JS -->
            </tbody>
        </table>
    </div>

    <!-- Interaction Notes -->
    <div class="alert a-info">
        <span class="alert-icon">ğŸ’¡</span>
        <div>
            <strong>Account switching rules:</strong><br>
            â€¢ Click <strong>Switch</strong> to enter that account. The page reloads with the new MID context.<br>
            â€¢ Click <strong>â­</strong> to set as default. Next login will auto-enter this account.<br>
            â€¢ Only <strong>one default</strong> account at a time. Setting a new default clears the previous one.<br>
            â€¢ <strong>Owner</strong> badge is shown if you are the Owner of that account (å¼€æˆ·äºº/æ³•äºº/è‘£äº‹).
        </div>
    </div>

    <!-- Topbar Dropdown Demo -->
    <div class="card">
        <div class="card-title">Topbar dropdown preview</div>
        <div class="card-desc">This is how the account switcher looks in the topbar. Click the user avatar area in the top-right corner to try it.</div>
        <div style="background:var(--bg); border-radius:var(--r); padding:20px; text-align:center;">
            <div style="font-size:13px; color:var(--t3); margin-bottom:8px;">ğŸ‘† Click the topbar user area (top-right) to open the account switcher dropdown</div>
        </div>
    </div>

    <!-- Owner Definition -->
    <div class="acct-settings-card">
        <div class="acct-settings-header">
            <h3>Owner definition</h3>
            <p>Owner requires identity verification. Only these types qualify:</p>
        </div>
        <div style="padding:16px 24px;">
            <div class="owner-def-item">
                <div class="def-icon">ğŸ‘¤</div>
                <div>
                    <div class="def-title">å¼€æˆ·äºº (Account Opener)</div>
                    <div class="def-sub">Created the MID and submitted KYC. Auto-assigned.</div>
                </div>
            </div>
            <div class="owner-def-item">
                <div class="def-icon">ğŸ›ï¸</div>
                <div>
                    <div class="def-title">æ³•äºº (Legal Representative)</div>
                    <div class="def-sub">Face recognition + mobile verification, or offline documents.</div>
                </div>
            </div>
            <div class="owner-def-item">
                <div class="def-icon">ğŸ“‹</div>
                <div>
                    <div class="def-title">è‘£äº‹ (Director)</div>
                    <div class="def-sub">Face recognition + mobile verification, or offline documents.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="btn-bar" style="justify-content:center;">
        <button class="btn btn-sec" onclick="goStep(5)">â† Back to Review</button>
        <button class="btn btn-pri" onclick="goStep(0);showToast('Flow complete! Start over from Step 1.','ok')">â†» Start over</button>
    </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Edit Menu Modal -->
<div class="ov" id="mEditMenu"><div class="modal" style="max-width:520px;"><button class="modal-x" onclick="closeModal('mEditMenu')">Ã—</button>
    <h3>Edit menu access for ç‹äº”</h3>
    <p class="mdesc">Toggle menus on/off. This overrides the role default for this specific user.</p>
    <div class="ck-grid" id="editMenuGrid">
        <!-- cloned from step 1 by JS -->
    </div>
    <div class="btn-bar mt-16">
        <button class="btn btn-sec" onclick="closeModal('mEditMenu')">Cancel</button>
        <button class="btn btn-pri" onclick="saveEditMenu()">Save changes</button>
    </div>
</div></div>

<!-- Edit Ops Modal -->
<div class="ov" id="mEditOps"><div class="modal"><button class="modal-x" onclick="closeModal('mEditOps')">Ã—</button>
    <h3>Edit operation permissions for ç‹äº”</h3>
    <p class="mdesc">Override the role default for this specific user. Click badges to toggle.</p>
    <table class="tbl">
        <thead><tr><th>Operation</th><th class="ctr">Verification</th></tr></thead>
        <tbody>
            <tr><td class="nm">Initiate transaction</td><td class="ctr"><span class="pb pb-self" onclick="togglePB(this)">Self</span></td></tr>
            <tr><td class="nm">Fund operations</td><td class="ctr"><span class="pb pb-owner" onclick="togglePB(this)">Owner</span></td></tr>
            <tr><td class="nm">Merchant config</td><td class="ctr"><span class="pb pb-owner" onclick="togglePB(this)">Owner</span></td></tr>
        </tbody>
    </table>
    <div class="btn-bar mt-16">
        <button class="btn btn-sec" onclick="closeModal('mEditOps')">Cancel</button>
        <button class="btn btn-pri" onclick="closeModal('mEditOps');showToast('Operation permissions updated','ok')">Save changes</button>
    </div>
</div></div>

<!-- Edit Data Modal -->
<div class="ov" id="mEditData"><div class="modal"><button class="modal-x" onclick="closeModal('mEditData')">Ã—</button>
    <h3>Edit data access for ç‹äº”</h3>
    <p class="mdesc">Toggle All â†” Own for each module. Click badges to toggle.</p>
    <table class="tbl" id="editDataModalTable">
        <thead><tr><th>Module</th><th class="ctr">Scope</th></tr></thead>
        <tbody id="editDataModalBody">
            <!-- filled by JS -->
        </tbody>
    </table>
    <div class="btn-bar mt-16">
        <button class="btn btn-sec" onclick="closeModal('mEditData')">Cancel</button>
        <button class="btn btn-pri" onclick="saveEditData()">Save changes</button>
    </div>
</div></div>


<script>
// ============ STATE ============
let currentStep = 0;
const STEPS = 7;

// ============ ACCOUNTS DATA ============
let accounts = [
    { id: 'MID-001', name: 'ABC Trading', role: 'Owner', ownerType: 'å¼€æˆ·äºº', isDefault: true, color: '#5b6cf5', initials: 'AB' },
    { id: 'MID-002', name: 'XYZ Corp', role: 'Admin', ownerType: null, isDefault: false, color: '#3b82f6', initials: 'XY' },
    { id: 'MID-003', name: 'Global Inc', role: 'Member', ownerType: null, isDefault: false, color: '#10b981', initials: 'GI' }
];
let currentAcctId = 'MID-001';

// Role being configured
let roleConfig = {
    name: 'é«˜çº§è´¢åŠ¡',
    base: 'è´¢åŠ¡',
    menus: [],
    menuOps: {}, // menu -> 'view' | 'operate'
    ops: { transaction: 'Self', fund: 'Owner', config: 'Owner' },
    data: {} // menu -> 'All' | 'Own'
};

// User being invited
let inviteConfig = {
    email: 'wang@newuser.com',
    roles: [] // role names
};

// All menus
const ALL_MENUS = [
    'Fiat Accounts','Crypto Wallet','Exchange',
    'Collection Tools','Remitter','Payins','Crypto Receive',
    'Online Payment','Invoice','Subscription',
    'Beneficiary','Payouts','Crypto Send','Remittance Orders',
    'Cards Management','Card Transactions',
    'Reports','Trade Documents','Developer','Settings'
];

// Preset role menus
const PRESETS = {
    'ç®¡ç†å‘˜': ALL_MENUS.slice(),
    'è´¢åŠ¡': ['Fiat Accounts','Crypto Wallet','Exchange','Payins','Crypto Receive','Beneficiary','Payouts','Crypto Send','Remittance Orders','Reports','Trade Documents'],
    'è¿è¥': ['Collection Tools','Remitter','Payins','Crypto Receive','Online Payment','Invoice','Subscription','Cards Management','Card Transactions','Reports']
};

// ============ NAVIGATION ============
function goStep(n) {
    if (n < 0 || n >= STEPS) return;
    currentStep = n;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
    document.getElementById('step-' + n).classList.add('on');
    updateRail();
    window.scrollTo(0, 0);
}

function updateRail() {
    const dots = document.querySelectorAll('.rail-dot');
    const labels = document.querySelectorAll('.rail-label');
    const bars = document.querySelectorAll('.rail-bar');
    dots.forEach((d, i) => {
        d.classList.remove('active', 'done');
        labels[i].classList.remove('active', 'done');
        if (i < currentStep) { d.classList.add('done'); d.textContent = 'âœ“'; labels[i].classList.add('done'); }
        else if (i === currentStep) { d.classList.add('active'); d.textContent = (i + 1); labels[i].classList.add('active'); }
        else { d.textContent = (i + 1); }
    });
    bars.forEach((b, i) => {
        b.classList.toggle('done', i < currentStep);
    });
}

// ============ TOAST ============
function showToast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.background = type === 'ok' ? 'var(--ok)' : type === 'err' ? 'var(--err)' : 'var(--pri)';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2500);
}

// ============ MODAL ============
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.ov').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('show'); }));

// ============ STEP 0: Configure Role ============
function pickBase(el, base) {
    el.parentElement.querySelectorAll('.tg').forEach(t => t.classList.remove('on'));
    el.classList.add('on');
    roleConfig.base = base;
}

function loadPreset(name) {
    document.getElementById('roleName').value = name;
    roleConfig.name = name;
    roleConfig.base = name;
    createRole();
}

function createRole() {
    roleConfig.name = document.getElementById('roleName').value || 'è‡ªå®šä¹‰è§’è‰²';
    // Apply base template to menu checkboxes
    const baseMenus = roleConfig.base === 'none' ? [] : (PRESETS[roleConfig.base] || []);
    document.querySelectorAll('#menuGrid .ck-item').forEach(item => {
        const menu = item.dataset.menu;
        if (baseMenus.includes(menu)) item.classList.add('on');
        else item.classList.remove('on');
    });
    document.getElementById('s1RoleName').textContent = roleConfig.name;
    document.getElementById('s2RoleName').textContent = roleConfig.name;
    goStep(1);
    showToast('Configuring "' + roleConfig.name + '"', 'info');
}

// ============ STEP 1: Menu & Ops ============
function ckToggle(el) { el.classList.toggle('on'); }

function setMenuOp(btn, level) {
    const opDiv = btn.parentElement;
    opDiv.querySelectorAll('.ck-op-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const item = opDiv.closest('.ck-item');
    item.dataset.op = level;
}

function togglePB(el) {
    if (el.textContent === 'Self') {
        el.textContent = 'Owner'; el.className = 'pb pb-owner';
    } else {
        el.textContent = 'Self'; el.className = 'pb pb-self';
    }
}

function saveMenuOps() {
    // Collect selected menus and their operation levels
    roleConfig.menus = [];
    roleConfig.menuOps = {};
    document.querySelectorAll('#menuGrid .ck-item.on').forEach(item => {
        roleConfig.menus.push(item.dataset.menu);
        roleConfig.menuOps[item.dataset.menu] = item.dataset.op || 'operate';
    });
    // Collect ops
    const opRows = document.querySelectorAll('#step-1 .tbl .pb');
    roleConfig.ops.transaction = opRows[0].textContent;
    roleConfig.ops.fund = opRows[1].textContent;
    roleConfig.ops.config = opRows[2].textContent;

    // Build data access table
    buildDataTable();
    goStep(2);
    showToast(roleConfig.menus.length + ' menus selected', 'ok');
}

// ============ STEP 2: Data Access ============
function buildDataTable() {
    const body = document.getElementById('dataBody');
    body.innerHTML = '';
    roleConfig.menus.forEach(menu => {
        roleConfig.data[menu] = roleConfig.data[menu] || 'Own';
        const scope = roleConfig.data[menu];
        const cls = scope === 'All' ? 'pb-all' : 'pb-own';
        body.innerHTML += `<tr><td class="nm">${menu}</td><td class="ctr"><span class="pb ${cls}" onclick="toggleDataPB(this,'${menu}')">${scope}</span></td></tr>`;
    });
}

function toggleDataPB(el, menu) {
    if (el.textContent === 'All') {
        el.textContent = 'Own'; el.className = 'pb pb-own';
        roleConfig.data[menu] = 'Own';
    } else {
        el.textContent = 'All'; el.className = 'pb pb-all';
        roleConfig.data[menu] = 'All';
    }
}

function saveDataAccess() {
    // Build role summary for step 3
    buildRoleSummary();
    buildRoleAssignGroup();
    goStep(3);
    showToast('Role "' + roleConfig.name + '" saved!', 'ok');
}

// ============ STEP 3: Invite ============
function buildRoleSummary() {
    const box = document.getElementById('roleSummaryBox');
    const menuTags = roleConfig.menus.map(m => {
        const op = roleConfig.menuOps[m] || 'operate';
        const opCls = op === 'view' ? 'op-view' : 'op-operate';
        const opText = op === 'view' ? 'ä»…æŸ¥é˜…' : 'å¯æ“ä½œ';
        return `<span class="tag-with-op b-pri">${m} <span class="op-label ${opCls}">${opText}</span></span>`;
    }).join(' ');
    box.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <div class="role-icon" style="background:var(--info-bg);">ğŸ’¼</div>
            <div>
                <div style="font-size:15px;font-weight:600;">${roleConfig.name}</div>
                <div style="font-size:12px;color:var(--t3);">${roleConfig.menus.length} menus Â· Ops: ${roleConfig.ops.transaction}/${roleConfig.ops.fund}/${roleConfig.ops.config}</div>
            </div>
        </div>
        <div style="font-size:12px;color:var(--t3);margin-bottom:6px;">Menu access & operation level:</div>
        <div class="tags" style="gap:6px;">${menuTags}</div>
    `;
}

function buildRoleAssignGroup() {
    const group = document.getElementById('roleAssignGroup');
    const roles = ['ç®¡ç†å‘˜', 'è´¢åŠ¡', 'è¿è¥', roleConfig.name];
    const unique = [...new Set(roles)];
    group.innerHTML = '';
    unique.forEach(r => {
        const isNew = r === roleConfig.name;
        group.innerHTML += `<div class="tg${isNew ? ' on' : ''}" onclick="toggleRoleAssign(this)">${r}</div>`;
    });
}

function toggleRoleAssign(el) { el.classList.toggle('on'); }

function setInvMethod(m) {
    document.getElementById('invEmail').classList.toggle('on', m === 'email');
    document.getElementById('invMobile').classList.toggle('on', m === 'mobile');
    document.getElementById('invEmailFg').style.display = m === 'email' ? 'block' : 'none';
    document.getElementById('invMobileFg').style.display = m === 'mobile' ? 'block' : 'none';
}

function sendInvite() {
    // Collect assigned roles
    inviteConfig.roles = [];
    document.querySelectorAll('#roleAssignGroup .tg.on').forEach(t => inviteConfig.roles.push(t.textContent));
    inviteConfig.email = document.getElementById('invAddress').value || 'wang@newuser.com';

    // Update step 4
    document.getElementById('s4RoleNames').textContent = inviteConfig.roles.join(' + ');
    document.getElementById('s4JoinedRoles').textContent = inviteConfig.roles.join(' + ');

    // Reset step 4 sub-steps
    document.getElementById('s4a').style.display = 'block';
    document.getElementById('s4b').style.display = 'none';
    document.getElementById('s4c').style.display = 'none';

    goStep(4);
    showToast('Invitation sent to ' + inviteConfig.email, 'ok');
}

// ============ STEP 4: User Registers ============
function s4GoRegister() {
    document.getElementById('s4a').style.display = 'none';
    document.getElementById('s4b').style.display = 'block';
}

function s4Complete() {
    document.getElementById('s4b').style.display = 'none';
    document.getElementById('s4c').style.display = 'block';

    // Build access summary
    const box = document.getElementById('s4AccessSummary');
    const menuTags = roleConfig.menus.map(m => {
        const op = roleConfig.menuOps[m] || 'operate';
        const opCls = op === 'view' ? 'op-view' : 'op-operate';
        const opText = op === 'view' ? 'ä»…æŸ¥é˜…' : 'å¯æ“ä½œ';
        return `<span class="tag-with-op b-pri">${m} <span class="op-label ${opCls}">${opText}</span></span>`;
    }).join(' ');
    box.innerHTML = `
        <div style="font-size:12px;color:var(--t3);margin-bottom:6px;">Your menu access & operation level:</div>
        <div class="tags" style="gap:6px;">${menuTags}</div>
    `;

    showToast('Account created! Joined ABC Trading.', 'ok');
}

// ============ STEP 5: Review & Modify ============
// This runs when entering step 5
function buildReviewPage() {
    // Roles
    const rolesDiv = document.getElementById('reviewRoles');
    rolesDiv.innerHTML = inviteConfig.roles.map(r => `<span class="badge b-pri">${r}</span>`).join(' ');

    // Menus (with operation level)
    const menusDiv = document.getElementById('reviewMenus');
    menusDiv.innerHTML = roleConfig.menus.map(m => {
        const op = roleConfig.menuOps[m] || 'operate';
        const opCls = op === 'view' ? 'op-view' : 'op-operate';
        const opText = op === 'view' ? 'ä»…æŸ¥é˜…' : 'å¯æ“ä½œ';
        return `<span class="tag-with-op b-pri">${m} <span class="op-label ${opCls}">${opText}</span></span>`;
    }).join(' ');

    // Ops
    const opsBody = document.getElementById('reviewOpsBody');
    opsBody.innerHTML = `
        <tr><td class="nm">Initiate transaction</td><td class="ctr"><span class="pb pb-${roleConfig.ops.transaction === 'Self' ? 'self' : 'owner'}">${roleConfig.ops.transaction}</span></td><td class="ctr"><span class="pb pb-${roleConfig.ops.transaction === 'Self' ? 'self' : 'owner'}" onclick="togglePB(this)">${roleConfig.ops.transaction}</span></td></tr>
        <tr><td class="nm">Fund operations</td><td class="ctr"><span class="pb pb-${roleConfig.ops.fund === 'Self' ? 'self' : 'owner'}">${roleConfig.ops.fund}</span></td><td class="ctr"><span class="pb pb-${roleConfig.ops.fund === 'Self' ? 'self' : 'owner'}" onclick="togglePB(this)">${roleConfig.ops.fund}</span></td></tr>
        <tr><td class="nm">Merchant config</td><td class="ctr"><span class="pb pb-${roleConfig.ops.config === 'Self' ? 'self' : 'owner'}">${roleConfig.ops.config}</span></td><td class="ctr"><span class="pb pb-${roleConfig.ops.config === 'Self' ? 'self' : 'owner'}" onclick="togglePB(this)">${roleConfig.ops.config}</span></td></tr>
    `;

    // Data
    const dataBody = document.getElementById('reviewDataBody');
    dataBody.innerHTML = '';
    roleConfig.menus.forEach(menu => {
        const scope = roleConfig.data[menu] || 'Own';
        const cls = scope === 'All' ? 'pb-all' : 'pb-own';
        dataBody.innerHTML += `<tr><td class="nm">${menu}</td><td class="ctr"><span class="pb ${cls}">${scope}</span></td></tr>`;
    });

    // Role toggles
    const togglesDiv = document.getElementById('reviewRoleToggles');
    const allRoles = [...new Set(['ç®¡ç†å‘˜', 'è´¢åŠ¡', 'è¿è¥', roleConfig.name])];
    togglesDiv.innerHTML = '';
    allRoles.forEach(r => {
        const isOn = inviteConfig.roles.includes(r);
        togglesDiv.innerHTML += `<div class="tg${isOn ? ' on' : ''}" onclick="toggleReviewRole(this,'${r}')">${r}</div>`;
    });

    // Edit menu modal
    buildEditMenuModal();
    // Edit data modal
    buildEditDataModal();
}

function toggleReviewRole(el, role) {
    el.classList.toggle('on');
    showToast('Role "' + role + '" ' + (el.classList.contains('on') ? 'added' : 'removed'), 'ok');
}

function buildEditMenuModal() {
    const grid = document.getElementById('editMenuGrid');
    grid.innerHTML = document.getElementById('menuGrid').innerHTML;
    // Sync on/off state and op level
    grid.querySelectorAll('.ck-item').forEach(item => {
        const menu = item.dataset.menu;
        if (roleConfig.menus.includes(menu)) {
            item.classList.add('on');
            item.dataset.op = roleConfig.menuOps[menu] || 'operate';
            // Sync op button active state
            const opBtns = item.querySelectorAll('.ck-op-btn');
            opBtns.forEach(b => b.classList.remove('active'));
            if (item.dataset.op === 'view' && opBtns[0]) opBtns[0].classList.add('active');
            else if (opBtns[1]) opBtns[1].classList.add('active');
        } else {
            item.classList.remove('on');
        }
        item.onclick = function() { ckToggle(this); };
        // Re-bind op button clicks
        item.querySelectorAll('.ck-op-btn').forEach(btn => {
            const level = btn.textContent.trim() === 'ä»…æŸ¥é˜…' ? 'view' : 'operate';
            btn.onclick = function(e) { e.stopPropagation(); setMenuOp(this, level); };
        });
        // Stop propagation on ck-op container
        const opDiv = item.querySelector('.ck-op');
        if (opDiv) opDiv.onclick = function(e) { e.stopPropagation(); };
    });
}

function saveEditMenu() {
    // Collect from modal with operation levels
    const newMenus = [];
    const newMenuOps = {};
    document.querySelectorAll('#editMenuGrid .ck-item.on').forEach(item => {
        newMenus.push(item.dataset.menu);
        newMenuOps[item.dataset.menu] = item.dataset.op || 'operate';
    });
    roleConfig.menus = newMenus;
    roleConfig.menuOps = newMenuOps;
    // Refresh review with op levels
    const menusDiv = document.getElementById('reviewMenus');
    menusDiv.innerHTML = roleConfig.menus.map(m => {
        const op = roleConfig.menuOps[m] || 'operate';
        const opCls = op === 'view' ? 'op-view' : 'op-operate';
        const opText = op === 'view' ? 'ä»…æŸ¥é˜…' : 'å¯æ“ä½œ';
        return `<span class="tag-with-op b-pri">${m} <span class="op-label ${opCls}">${opText}</span></span>`;
    }).join(' ');
    closeModal('mEditMenu');
    showToast('Menu access updated (' + newMenus.length + ' menus)', 'ok');
}

function buildEditDataModal() {
    const body = document.getElementById('editDataModalBody');
    body.innerHTML = '';
    roleConfig.menus.forEach(menu => {
        const scope = roleConfig.data[menu] || 'Own';
        const cls = scope === 'All' ? 'pb-all' : 'pb-own';
        body.innerHTML += `<tr><td class="nm">${menu}</td><td class="ctr"><span class="pb ${cls}" onclick="toggleEditDataPB(this,'${menu}')">${scope}</span></td></tr>`;
    });
}

function toggleEditDataPB(el, menu) {
    if (el.textContent === 'All') {
        el.textContent = 'Own'; el.className = 'pb pb-own';
        roleConfig.data[menu] = 'Own';
    } else {
        el.textContent = 'All'; el.className = 'pb pb-all';
        roleConfig.data[menu] = 'All';
    }
}

function saveEditData() {
    // Refresh review data table
    const dataBody = document.getElementById('reviewDataBody');
    dataBody.innerHTML = '';
    roleConfig.menus.forEach(menu => {
        const scope = roleConfig.data[menu] || 'Own';
        const cls = scope === 'All' ? 'pb-all' : 'pb-own';
        dataBody.innerHTML += `<tr><td class="nm">${menu}</td><td class="ctr"><span class="pb ${cls}">${scope}</span></td></tr>`;
    });
    closeModal('mEditData');
    showToast('Data access updated', 'ok');
}

// ============ ACCOUNT SWITCHER ============
function toggleAcctDropdown(e) {
    e.stopPropagation();
    const dd = document.getElementById('acctDropdown');
    dd.classList.toggle('show');
    if (dd.classList.contains('show')) renderAcctDropdown();
}

document.addEventListener('click', () => {
    document.getElementById('acctDropdown').classList.remove('show');
});

function renderAcctDropdown() {
    const list = document.getElementById('acctDdList');
    list.innerHTML = '';
    accounts.forEach(a => {
        const isCurrent = a.id === currentAcctId;
        const isOwner = a.role === 'Owner';
        let badges = '';
        if (isOwner) badges += `<span class="owner-crown">ğŸ‘‘ Owner</span>`;
        if (a.ownerType) badges += `<span class="owner-type-badge">${a.ownerType}</span>`;
        list.innerHTML += `
            <div class="acct-dd-item ${isCurrent ? 'current' : ''}" onclick="event.stopPropagation();">
                <div class="acct-avatar" style="background:${a.color};">${a.initials}</div>
                <div class="acct-info">
                    <div class="acct-name">${a.name} ${isOwner ? '<span class="owner-crown">ğŸ‘‘ Owner</span>' : ''}</div>
                    <div class="acct-mid">${a.id} Â· ${a.role}</div>
                    ${a.ownerType ? '<div class="acct-badges"><span class="owner-type-badge">' + a.ownerType + '</span></div>' : ''}
                </div>
                <div class="acct-dd-actions">
                    <button class="acct-star ${a.isDefault ? 'default' : ''}" onclick="event.stopPropagation(); setDefaultAcct('${a.id}');" title="${a.isDefault ? 'Default account' : 'Set as default'}">${a.isDefault ? 'â­' : 'â˜†'}</button>
                    <button class="acct-switch-btn" onclick="event.stopPropagation(); switchAcct('${a.id}');">${isCurrent ? 'Current' : 'Switch'}</button>
                </div>
            </div>
        `;
    });
}

function setDefaultAcct(id) {
    accounts.forEach(a => a.isDefault = (a.id === id));
    renderAcctDropdown();
    renderAcctSettings();
    showToast('Default account set to ' + accounts.find(a => a.id === id).name, 'ok');
}

function switchAcct(id) {
    if (id === currentAcctId) return;
    currentAcctId = id;
    const acct = accounts.find(a => a.id === id);
    document.getElementById('topbarAcctName').textContent = 'å¼ ä¸‰ Â· ' + acct.name;
    document.querySelector('.topbar-avatar').textContent = 'å¼ ';
    document.getElementById('acctDropdown').classList.remove('show');
    renderAcctSettings();
    showToast('Switched to ' + acct.name + ' (' + id + ')', 'ok');
}

// ============ ACCOUNTS SETTINGS PAGE ============
function renderAcctSettings() {
    const body = document.getElementById('acctSettingsBody');
    if (!body) return;
    body.innerHTML = '';
    accounts.forEach(a => {
        const isCurrent = a.id === currentAcctId;
        const isOwner = a.role === 'Owner';
        body.innerHTML += `
            <tr${isCurrent ? ' style="background:var(--pri-l);"' : ''}>
                <td>
                    <div class="acct-name-cell">
                        <div class="acct-icon" style="background:${a.color};">${a.initials}</div>
                        <div class="acct-text">
                            <div class="name">${a.name} ${isCurrent ? '<span class="badge b-pri" style="margin-left:6px;">Current</span>' : ''}</div>
                            <div class="mid">${a.id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge ${isOwner ? 'b-ok' : a.role === 'Admin' ? 'b-pri' : 'b-muted'}">${a.role}</span>
                </td>
                <td>
                    ${isOwner && a.ownerType ? '<span class="owner-crown">ğŸ‘‘ ' + a.ownerType + '</span>' : '<span style="color:var(--t3);">â€”</span>'}
                </td>
                <td style="text-align:center;">
                    <span class="default-star-lg ${a.isDefault ? 'active' : ''}" onclick="setDefaultAcct('${a.id}')" title="${a.isDefault ? 'Default account' : 'Set as default'}">${a.isDefault ? 'â­' : 'â˜†'}</span>
                </td>
                <td style="text-align:center;">
                    ${isCurrent
                        ? '<span style="font-size:12px; color:var(--t3);">Current</span>'
                        : '<button class="btn btn-sm btn-sec" onclick="switchAcct(\'' + a.id + '\')">Switch â†’</button>'
                    }
                </td>
            </tr>
        `;
    });
}

function switchSettingsTab(tab) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    if (tab === 'accounts') document.getElementById('tabAccounts').classList.add('active');
    else event.target.classList.add('active');
    if (tab !== 'accounts') showToast('Tab "' + tab + '" not in this prototype', 'info');
}

// Override goStep to trigger review build & account settings
const _goStep = goStep;
goStep = function(n) {
    _goStep(n);
    if (n === 5) buildReviewPage();
    if (n === 6) { renderAcctSettings(); document.getElementById('acctDropdown').classList.remove('show'); }
};

// Init dropdown on load
renderAcctDropdown();
</script>
</body>
</html>
