# EX Platform — TP 端用户与权限 PRD

## 文档概述

本文档定义 TP（Tenant Portal，租户端）的用户与权限体系。TP 是租户（与 EX 签约的机构）的管理后台，用户体系与 MP（商户端）有本质区别。

**与 MP 的核心差异：**

| 维度 | MP（商户端） | TP（租户端） |
|------|-------------|-------------|
| **入驻方式** | 商户自行注册 | EX 与租户签约后，EX 发送激活邮件给租户管理员 |
| **用户来源** | 邀请制（邮箱/手机号邀请） | 后台创建制（管理员直接创建用户账号） |
| **Account Holder** | 注册人自动成为 AH | EX 指定的租户管理员 |
| **2FA / 安全验证** | 支持 2FA、Designated Phone | 本期不需要 |
| **手机号** | 注册时可用手机号 | 用户登录后可选绑定，用于找回密码 |
| **密码找回** | 邮箱/手机号 | 邮箱（必须记录邮箱） |

**设计参考：** Adyen Customer Area、Stripe Dashboard 等 B2B SaaS 后台用户管理。

---

## 1. 身份模型

### 1.1 TP 端身份结构

TP 端复用 EX Platform 的三层身份模型（Identity → User → TID），但入驻和用户创建方式不同。

```
Identity（自然人）
├── 拥有凭证：邮箱（必填）、手机号（可选，登录后绑定）
├── 拥有安全设置：密码
│
├── User UID-T01 → TID-001 (Fulunited Limited) / Admin
│   └── 角色: 超级管理员（所有模块可操作）
│
└── User UID-T02 → TID-001 (Fulunited Limited) / Member
    └── 角色: 客户经理（客户中心可操作）
```

**TID（Tenant ID）：** 租户标识，等同于 MP 端的 MID。每个签约机构一个 TID。

### 1.2 Identity 与 MP 的关系

- 同一邮箱可分别在 MP 和 TP 注册/激活，各自创建**独立的 Identity**
- MP Identity 和 TP Identity 各自有独立的密码
- 登录时选择端（MP / TP），进入对应体系
- 本期不支持 MP 和 TP 的 Identity 合并

### 1.3 账号层级说明

| 层级 | 实体 | 标识 | 职责 |
|------|------|------|------|
| **Identity 层** | Identity | IID | 自然人。拥有：邮箱（必填）、手机号（可选）、密码 |
| **User 层** | User | UID | 该自然人在某个 TID 下的成员身份。承载：角色、权限 |
| **租户层** | Tenant | TID | 租户机构（与 EX 签约的公司） |

---

## 2. 租户激活流程

### 2.1 流程说明

租户不能自行注册。EX 与租户签约后，由 EX 运营人员在 SA（Super Admin）后台为租户创建 TID，并指定租户管理员邮箱，系统发送激活邮件。

**流程步骤：**

1. EX 运营在 SA 后台创建租户（TID），填写租户管理员邮箱
2. 系统发送激活邮件到该邮箱，包含激活链接（有效期 72 小时）
3. 租户管理员点击邮件中的激活链接，跳转到 TP 激活页面
4. 激活页面要求设置登录密码（需符合密码强度要求）
5. 密码设置成功 → Identity 创建完成，User 自动生成并标记为 Admin
6. 自动登录进入 TP 后台

### 2.2 激活规则

| 规则 | 说明 |
|------|------|
| **激活链接有效期** | 72 小时，过期后需 EX 运营重新发送 |
| **仅可使用一次** | 激活链接点击并完成设置后失效 |
| **密码要求** | 至少 8 位，包含大小写字母 + 数字 + 特殊字符 |
| **邮箱唯一性** | 同一邮箱在 TP 端只能关联一个 Identity |
| **重复发送** | 未激活时，EX 运营可重新发送激活邮件（旧链接失效） |

### 2.3 激活失败处理

| 场景 | 处理 |
|------|------|
| 链接过期 | 提示"链接已过期，请联系 EX 运营重新发送" |
| 链接已使用 | 提示"该账号已激活，请直接登录" |
| 邮箱已存在 TP Identity | 提示"该邮箱已注册，请直接登录"，并通知 EX 运营 |

---

## 3. 用户管理

### 3.1 用户创建方式

TP 端不使用邀请制，而是由管理员直接在后台创建用户账号。

**创建流程：**

1. 管理员进入 Settings → Users & Permissions → Users 列表
2. 点击「Create User」
3. 填写用户信息：
   - **姓名**（必填）
   - **邮箱**（必填，用于登录和密码找回）
   - **角色**（必填，至少分配一个角色）
4. 系统创建 Identity + User，生成临时密码
5. 系统发送邮件到该邮箱，包含：
   - 登录地址
   - 临时密码
   - 提示首次登录后必须修改密码

### 3.2 用户创建规则

| 规则 | 说明 |
|------|------|
| **邮箱必填** | 用于登录凭证和密码找回，不可为空 |
| **邮箱唯一** | 同一 TID 下邮箱不可重复；跨 TID 可重复（不同 Identity） |
| **临时密码** | 系统自动生成，首次登录强制修改 |
| **角色必填** | 创建时必须分配至少一个角色 |
| **手机号可选** | 创建时不需要手机号，用户登录后可自行绑定 |

### 3.3 用户状态

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| **Active** | 正常使用 | 登录、执行权限范围内操作 |
| **Pending** | 已创建，未首次登录 | 等待用户首次登录并修改密码 |
| **Disabled** | 已禁用 | 不可登录，保留数据。管理员可重新启用 |

**状态流转：**

- 创建 → **Pending**
- 首次登录并修改密码 → **Active**
- 管理员禁用 → **Disabled**
- 管理员启用 → **Active**

### 3.4 用户操作

| 操作 | 执行人 | 说明 |
|------|--------|------|
| **创建用户** | Admin / 有用户管理权限的角色 | 填写姓名+邮箱+角色，系统发送临时密码 |
| **编辑用户** | Admin / 有用户管理权限的角色 | 修改姓名、角色分配 |
| **禁用用户** | Admin / 有用户管理权限的角色 | 用户不可登录，保留数据 |
| **启用用户** | Admin / 有用户管理权限的角色 | 恢复登录能力 |
| **重置密码** | Admin / 有用户管理权限的角色 | 生成新临时密码并发送邮件 |
| **删除用户** | Admin | 彻底删除（需确认，不可恢复） |

### 3.5 密码找回

用户忘记密码时，可通过邮箱自助找回：

1. 在登录页点击「Forgot Password」
2. 输入注册邮箱
3. 系统发送密码重置链接到该邮箱（有效期 1 小时）
4. 点击链接，设置新密码
5. 新密码生效，旧密码失效

> 这是邮箱必填的核心原因：确保用户可自助找回密码，减少管理员负担。

### 3.6 手机号绑定

用户登录后可在个人设置中绑定手机号：

- 手机号为可选项，不强制
- 绑定后可作为备用登录凭证
- 本期不用于 2FA 或安全验证
- 后续版本可扩展为 2FA 渠道

---

## 4. 角色体系

### 4.1 角色分类

| 分类 | 说明 |
|------|------|
| **Admin（管理员）** | 租户激活时自动创建，拥有所有权限，不可删除 |
| **自定义角色** | 管理员创建，按需配置页面权限和操作权限 |

> Admin 等同于 MP 端的 Account Holder，是 TID 下的最高权限用户。

### 4.2 Admin 固有权限

| 能力 | 说明 |
|------|------|
| **所有模块访问** | 可见所有模块，可操作 |
| **用户管理** | 创建/编辑/禁用/删除用户 |
| **角色管理** | 创建/编辑/删除角色 |
| **TID 设置** | 租户信息、通知、系统配置 |
| **不可删除** | Admin 不能被其他人删除或降级 |
| **可转让** | Admin 可将管理员身份转让给 TID 内其他 User |

### 4.3 角色属性

| 属性 | 说明 |
|------|------|
| **role_id** | 唯一标识 |
| **tid** | 所属 TID |
| **role_name** | 角色名称（如"客户经理"） |
| **description** | 角色描述（可选） |
| **permissions** | 该角色拥有的权限列表 |
| **created_by** | 创建人 |
| **created_at** | 创建时间 |
| **status** | Active / Disabled |

### 4.4 创建角色流程

1. Admin 或有角色管理权限的用户进入 Settings → Users & Permissions → Roles
2. 点击「Create Role」
3. 输入角色名称和描述（可选）
4. 配置权限：选择可访问的模块（页面权限）→ 对每个模块勾选操作权限（查阅/操作/导出）
5. 保存角色

---

## 5. 权限模型

### 5.1 两层权限

与 MP 端一致，采用两层权限模型：

- **Layer 1: 页面权限** — 控制用户能看到哪些模块
- **Layer 2: 操作权限** — 在可见模块内，控制查阅 / 操作 / 导出（三选多选）

### 5.2 TP 端模块清单

> **Dashboard** 所有人都有，不受权限控制，内容根据权限动态生成。

| # | 模块分组 | 包含子菜单 | 说明 | 权限标识 |
|---|---------|-----------|------|---------|
| 1 | **Product Center** | Products / Pricing / Packages | 产品管理：产品配置、定价方案、套餐管理 | `product` |
| 2 | **Customer Center** | Merchants / Applications / KYC Review | 客户管理：商户列表、入驻审核、KYC 审核 | `customer` |
| 3 | **Settlement Center** | Settlement Rules / Settlement Records / Reconciliation | 清算管理：清算规则、清算记录、对账 | `settlement` |
| 4 | **Channel Center** | Channels / Routing Rules / Channel Monitoring | 渠道管理：渠道配置、路由规则、渠道监控 | `channel` |
| 5 | **Treasury Center** | Treasury Accounts / Fund Flows / Liquidity | 财资管理：资金账户、资金流水、流动性管理 | `treasury` |
| 6 | **Compliance & Risk** | KYC Config / Risk Rules / AML Monitoring / Sanctions | 合规风控：KYC 配置、风控规则、反洗钱、制裁筛查 | `compliance` |
| 7 | **Reports** | Reports / Downloads | 报表与下载中心 | `reports` |
| 8 | **Settings** | Tenant Profile / Users & Permissions / Notifications | 设置：租户信息、用户权限管理、通知配置 | `settings` |

### 5.3 操作权限（三选多选）

与 MP 端一致：

| 操作权限 | 标识 | 说明 |
|---------|------|------|
| **查阅（View）** | `view` | 查看列表、详情、筛选、搜索 |
| **操作（Operate）** | `operate` | 创建/编辑/删除/审批等写操作 |
| **导出（Export）** | `export` | 导出 CSV / Excel / PDF |

**勾选规则：**

- 三项独立勾选，可任意组合
- 勾选 `operate` 或 `export` 时，系统自动带上 `view`
- 至少勾选一项才算有该模块权限

### 5.4 角色配置示例

#### 角色 1: 客户经理

负责商户入驻审核和客户管理。

```
┌──────────────────┬────────┬────────┬────────┐
│ 模块               │ 查阅   │ 操作   │ 导出   │
├──────────────────┼────────┼────────┼────────┤
│ Customer Center    │ ☑      │ ☑      │ ☑      │  ← 商户管理、审核
│ Compliance & Risk  │ ☑      │ ☐      │ ☐      │  ← 查看 KYC/风控状态
│ Reports            │ ☑      │ ☐      │ ☑      │  ← 查看导出报表
└──────────────────┴────────┴────────┴────────┘
```

#### 角色 2: 清算运营

负责清算和对账。

```
┌──────────────────┬────────┬────────┬────────┐
│ 模块               │ 查阅   │ 操作   │ 导出   │
├──────────────────┼────────┼────────┼────────┤
│ Settlement Center  │ ☑      │ ☑      │ ☑      │  ← 清算规则、对账
│ Channel Center     │ ☑      │ ☐      │ ☐      │  ← 查看渠道状态
│ Treasury Center    │ ☑      │ ☐      │ ☐      │  ← 查看资金流水
│ Reports            │ ☑      │ ☐      │ ☑      │  ← 查看导出报表
└──────────────────┴────────┴────────┴────────┘
```

#### 角色 3: 风控专员

负责合规和风控管理。

```
┌──────────────────┬────────┬────────┬────────┐
│ 模块               │ 查阅   │ 操作   │ 导出   │
├──────────────────┼────────┼────────┼────────┤
│ Customer Center    │ ☑      │ ☐      │ ☐      │  ← 查看商户信息
│ Compliance & Risk  │ ☑      │ ☑      │ ☑      │  ← KYC/AML/风控操作
│ Reports            │ ☑      │ ☐      │ ☑      │  ← 查看导出报表
└──────────────────┴────────┴────────┴────────┘
```

#### 角色 4: 全局查看者

只读权限，查看所有模块。

```
┌──────────────────┬────────┬────────┬────────┐
│ 模块               │ 查阅   │ 操作   │ 导出   │
├──────────────────┼────────┼────────┼────────┤
│ Product Center     │ ☑      │ ☐      │ ☐      │
│ Customer Center    │ ☑      │ ☐      │ ☐      │
│ Settlement Center  │ ☑      │ ☐      │ ☐      │
│ Channel Center     │ ☑      │ ☐      │ ☐      │
│ Treasury Center    │ ☑      │ ☐      │ ☐      │
│ Compliance & Risk  │ ☑      │ ☐      │ ☐      │
│ Reports            │ ☑      │ ☐      │ ☐      │
│ Settings           │ ☑      │ ☐      │ ☐      │
└──────────────────┴────────┴────────┴────────┘
```

---

## 6. 登录与安全

### 6.1 登录方式

| 方式 | 说明 |
|------|------|
| **邮箱 + 密码** | 主要登录方式（邮箱必填） |
| **手机号 + 密码** | 绑定手机号后可用 |

### 6.2 首次登录

用户首次使用临时密码登录后，系统强制要求修改密码：

1. 输入临时密码登录
2. 系统跳转到「修改密码」页面
3. 输入新密码（需符合密码强度要求）
4. 修改成功，用户状态从 Pending → Active
5. 进入 TP 后台

### 6.3 密码策略

| 规则 | 说明 |
|------|------|
| **最小长度** | 8 位 |
| **复杂度** | 至少包含：大写字母、小写字母、数字、特殊字符 |
| **不可复用** | 新密码不能与最近 5 次密码相同 |
| **过期策略** | 本期不强制过期（后续可配置 90 天强制修改） |
| **锁定策略** | 连续 5 次密码错误，账号锁定 30 分钟 |

### 6.4 本期不需要的安全功能

以下功能本期不做，后续版本按需扩展：

- ❌ 2FA（双因素认证）
- ❌ Designated Phone（指定手机号验证）
- ❌ 安全验证手机号
- ❌ 登录 IP 白名单

---

## 7. 版本记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02-14 | 初始版本：TP 端用户与权限 |
