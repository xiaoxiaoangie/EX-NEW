# 基于IPL和BB能力的承兑产品设计文档

## 文档信息

| 项目     | 内容                 |
| -------- | -------------------- |
| 文档版本 | v2.0                 |
| 创建日期 | 2026-01-31           |
| 文档状态 | 草稿                 |
| 产品名称 | 数法融合承兑解决方案 |
| MVP范围  | IPL + BB（统一账户） |

---

## 目录

1. [文档背景](#1-文档背景)
2. [业务模块概览](#2-业务模块概览)
   - 2.5 [MVP简化方案](#25-mvp简化方案)
   - 2.6 [&#34;数法融合&#34;定位](#26-数法融合定位)
3. [模块一：商户入网与产品开通](#3-模块一商户入网与产品开通)
   - 3.4.1 [三种产品开通方式](#341-三种产品开通方式)
4. [模块二：租户配置](#4-模块二租户配置)
5. [模块三：交易处理](#5-模块三交易处理)
6. [模块四：对账清算](#6-模块四对账清算)
7. [附录：需求清单](#7-附录需求清单)

---

## 1. 文档背景

### 1.1 多视角架构分析

本文档从三个视角分析承兑产品架构：**EX视角**（SaaS平台）、**SP视角**（服务提供商内部）、**TP视角**（租户使用）。

#### 1.1.1 EX视角：SaaS平台架构

EX是一家科技公司，提供 **Payment Platform as a Service** 服务。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      EX SaaS 平台架构（EX视角）                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              SA (SaaS Admin)                                │
│                           EX 平台管理后台                                    │
│              - SP管理  - 租户管理  - 全局配置  - 数据统计                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
        ┌───────────────────┐           ┌───────────────────┐
        │   BB (SP)         │           │   IPL (SP)        │
        │  ┌─────────────┐  │           │  ┌─────────────┐  │
        │  │  PP Portal  │  │           │  │  PP Portal  │  │
        │  └─────────────┘  │           │  └─────────────┘  │
        │                   │           │                   │
        │  承兑服务商        │           │  法币服务商        │
        │  - 数币钱包        │           │  - VA 收款         │
        │  - 承兑引擎        │           │  - POBO 出款       │
        │  - 大账户代收付    │           │  - 法币账户        │
        │  - 法币账户        │           │                   │
        └───────────────────┘           └───────────────────┘
                    │
                    │ 提供支付能力
                    ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         Tenant (租户层)                                    │
│                    如: 环球、TC、WB、FOPAY等                                │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                         TP (Tenant Portal)                          │  │
│  │              - 商户管理  - 费率配置  - 交易查看  - 渠道配置            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
                    │
                    │ 商户归属于租户
                    ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         Merchant (商户层)                                  │
│                      最终使用支付服务的企业客户                              │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                         MP (Merchant Portal)                        │  │
│  │              - 交易查询  - 出款申请  - 账户管理  - 对账下载            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘

【关键点】
- EX平台只看到 BB 和 IPL 两个SP
- XPAY 不在EX生态中体现，EX看不到XPAY
- Channel（渠道）是SP内部概念，不在EX层面暴露
```

#### 1.1.2 SP视角：BB内部架构（含底层Channel）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      BB 内部架构（SP视角）                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              BB (SP)                                        │
│                           PP Portal                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         BB 核心能力                                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │   │
│  │  │ 数币钱包  │  │ 承兑引擎  │  │ 法币账户  │  │ 大账户    │            │   │
│  │  │(USDT/USDC)│  │(数币→法币)│  │          │  │ 代收付    │            │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ 法币出款能力                            │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    BB 底层 Channel（渠道层）                         │   │
│  │                    ⚠️ 仅在BB系统内部可见，EX/TP不可见                  │   │
│  │                                                                     │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │   │
│  │  │  BB大账户        │    │  XPAY渠道       │    │  其他渠道       │ │   │
│  │  │  (自有)          │    │  (代理行模式)   │    │  (未来扩展)     │ │   │
│  │  │                 │    │                 │    │                 │ │   │
│  │  │  - 代收代付      │    │  - VA收款       │    │                 │ │   │
│  │  │  - 当前主要方式  │    │  - POBO出款     │    │                 │ │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

【关键点】
- XPAY是BB的底层Channel，不是独立的SP
- Channel在BB系统内部管理，EX和TP看不到
- BB对外暴露的是统一的承兑能力，底层用哪个Channel是BB内部决策
- 租户只需与BB签约，无需关心BB用什么Channel
```

#### 1.1.3 TP视角：租户看到的能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      租户视角（TP视角）                                      │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   租户(TP)  │
                              │  环球/TC等   │
                              └──────┬──────┘
                                     │
                 ┌───────────────────┼───────────────────┐
                 │                   │                   │
                 ▼                   ▼                   ▼
        ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
        │  BB承兑服务     │  │  IPL法币服务   │  │  BB+IPL联合    │
        │  (单方签约)     │  │  (需双方签约)  │  │  (双方签约)    │
        └───────┬────────┘  └───────┬────────┘  └───────┬────────┘
                │                   │                   │
                ▼                   ▼                   ▼
        ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
        │ 租户看到的能力  │  │ 租户看到的能力  │  │ 租户看到的能力  │
        │                │  │                │  │                │
        │ - 数币收款      │  │ - VA收款       │  │ - 数币收款      │
        │ - 承兑          │  │ - POBO出款     │  │ - 承兑          │
        │ - 法币出款      │  │ - 法币账户     │  │ - VA收款(IPL)   │
        │   (BB大账户/    │  │                │  │ - POBO出款(IPL) │
        │    XPAY渠道)   │  │                │  │ - 法币账户(IPL) │
        │ - 法币账户(BB)  │  │                │  │                │
        └────────────────┘  └────────────────┘  └────────────────┘
                │                   │                   │
                ▼                   ▼                   ▼
        ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
        │ Off-ramp可见   │  │ Off-ramp可见   │  │ Off-ramp可见   │
        │ BB法币账户     │  │ IPL法币账户    │  │ IPL法币账户    │
        └────────────────┘  └────────────────┘  └────────────────┘

【关键点】
- 租户看不到XPAY，只看到BB提供的能力
- BB内部用大账户还是XPAY渠道，对租户透明
- 租户关心的是：签约谁、资金在哪里可见
```

#### 1.1.4 平台角色说明

| 角色                 | 英文                  | Portal | 说明                                                         |
| -------------------- | --------------------- | ------ | ------------------------------------------------------------ |
| **平台管理员** | SaaS Admin            | SA     | EX平台总管理后台                                             |
| **服务提供商** | Service Provider (SP) | PP     | 提供底层支付能力（收付款、承兑、数币收单、法币收单、发卡等） |
| **租户**       | Tenant                | TP     | 使用SP能力，为商户提供支付服务                               |
| **商户**       | Merchant              | MP     | 最终使用支付服务的企业，必须归属于某个租户                   |
| **渠道**       | Channel               | -      | SP内部概念，不在EX/TP层面暴露                                |

### 1.2 服务提供商(SP)与合作模式

#### 1.2.1 EX平台中的SP

| SP            | 类型       | 核心能力                                           | 与EX关系         |
| ------------- | ---------- | -------------------------------------------------- | ---------------- |
| **BB**  | 承兑服务商 | 数币钱包、承兑(数币→法币)、大账户代收付、法币账户 | 直接集成         |
| **IPL** | 法币服务商 | VA收款、POBO出款、法币账户                         | 集团内部隐藏合作 |

> **注意**：XPAY不是SP，是BB的底层Channel，不在EX生态中体现。

#### 1.2.2 BB内部的Channel

| Channel            | 类型     | 能力             | 说明                       |
| ------------------ | -------- | ---------------- | -------------------------- |
| **BB大账户** | 自有渠道 | 代收代付         | 当前主要方式               |
| **XPAY**     | 外部渠道 | VA收款、POBO出款 | 代理行模式，BB的渠道合作方 |

#### 1.2.3 IPL模式 vs BB模式（从TP视角）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   IPL模式 vs BB模式（TP视角对比）                            │
└─────────────────────────────────────────────────────────────────────────────┘

【IPL模式】                              【BB模式】
  租户需签约2家SP                          租户只需签约1家SP
  
  ┌─────────┐  ┌─────────┐                 ┌─────────────────────┐
  │   BB    │  │   IPL   │                 │         BB          │
  │  (SP)   │  │  (SP)   │                 │        (SP)         │
  └────┬────┘  └────┬────┘                 │  ┌───────────────┐  │
       │            │                      │  │ 底层Channel:   │  │
       │  双方入网   │                      │  │ - BB大账户     │  │
       │  (客户无感知)│                      │  │ - XPAY渠道    │  │
       ▼            ▼                      │  └───────────────┘  │
  ┌─────────────────────┐                 └──────────┬──────────┘
  │       租户(TP)       │                           │
  └─────────────────────┘                           │ 单方入网
                                                    ▼
  Off-ramp后资金可见：                        ┌─────────────┐
  ┌─────────────────────┐                    │   租户(TP)  │
  │   IPL 法币账户       │                    └─────────────┘
  └─────────────────────┘              
                                             Off-ramp后资金可见：
                                             ┌─────────────┐
                                             │ BB 法币账户  │
                                             └─────────────┘
```

| 对比项                     | IPL模式                   | BB模式（含XPAY渠道）         |
| -------------------------- | ------------------------- | ---------------------------- |
| **签约SP**           | BB + IPL（2家）           | BB（1家）                    |
| **入网方式**         | 双方入网（客户无感知）    | 单方入网                     |
| **对外关系**         | IPL不作为BB渠道，非代理行 | XPAY是BB内部渠道，对外不可见 |
| **Off-ramp资金可见** | IPL法币账户               | BB法币账户                   |
| **适用客户**         | 有贸易背景的合规客户      | 通用客户                     |
| **XPAY对租户可见性** | 不涉及                    | 不可见（BB内部决策）         |

#### 1.2.4 BB定位（SP视角）

- **承兑服务商**：具备数币钱包和法币账户能力
- **当前能力**：可用自有大账户代收/代付客户资金
- **扩展能力**：通过XPAY渠道（BB内部Channel），代理行模式，具备VA和POBO能力
- **对外暴露**：统一的承兑服务能力，底层Channel对租户透明

#### 1.2.5 IPL定位（SP视角）

- **纯法币服务商(SP)**：仅提供法币VA收款和POBO出款能力
- **合作模式**：与BB为集团内部"隐藏"合作，对外不作为BB渠道，非代理行模式
- **客户入网**：客户需双方入网（客户无感知）
- **核心价值**：为BB中有贸易背景的客户提供法币能力

#### 1.2.6 XPAY定位（BB内部Channel）

- **BB的底层渠道**：不是独立SP，是BB的Channel
- **合作模式**：BB与XPAY是渠道合作，代理行模式
- **对外可见性**：EX和TP都看不到XPAY，只在BB系统内部管理
- **核心价值**：为BB提供独立的法币VA和POBO能力，补充BB大账户的能力

### 1.3 客户画像

1. **WEB2外贸/服贸客户**

   - 在数币友好国家开展业务
   - 买家需用数币付款
   - 原因：汇率不稳定（稳定币合法）或外汇管制严格
2. **WEB3行业客户**

   - 需要WEB2行业的off-ramp渠道能力
   - 收到数币后需回到现实世界消费/支付
   - 面临银行对WEB3背景资金不友好的问题

### 1.3 客户痛点

1. WEB2客户想收WEB3货币，需要有人提供WEB3收款能力（地址、承兑等）
2. WEB2/WEB3客户收到数币后，给供应商/服务商付款仍需法币能力，付款行需是WEB2银行

---

## 2. 业务模块概览

### 2.1 业务流程总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           承兑业务完整流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
  │  模块一       │     │  模块二       │     │  模块三       │     │  模块四       │
  │  商户入网     │ ──> │  租户配置     │ ──> │  交易处理     │ ──> │  对账清算     │
  └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
        │                    │                    │                    │
        ▼                    ▼                    ▼                    ▼
  - 商户创建           - 费率配置           - 数币收款           - 交易对账
  - SP能力开通         - SP能力配置         - 承兑处理           - 费用结算
  - KYC/KYB审核        - 出款规则配置       - 法币出款           - 账单生成
                                            - 退款处理
```

### 2.2 核心角色与交互逻辑

> **核心逻辑**：
>
> - **SP提供产品**：BB、IPL作为服务提供商，提供底层支付能力（产品）
> - **TP代理产品**：租户签约SP后，代理SP的产品，可以看到SP
> - **MP使用产品**：商户只使用产品，**无需感知SP的存在**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         角色与产品关系                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          SP层（提供产品）                                │
  │                                                                         │
  │   ┌─────────────────────┐         ┌─────────────────────┐              │
  │   │  BB (SP)            │         │  IPL (SP)           │              │
  │   │                     │         │                     │              │
  │   │  提供产品：          │         │  提供产品：          │              │
  │   │  - 数币承兑服务      │         │  - VA收款服务        │              │
  │   │  - 法币出款服务      │         │  - POBO出款服务      │              │
  │   └─────────────────────┘         └─────────────────────┘              │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ TP签约SP，代理产品
                                    │ TP能看到SP
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          TP层（代理产品）                                │
  │                                                                         │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │  租户(TP) - 如：环球、TC、WB、FOPAY                              │   │
  │   │                                                                 │   │
  │   │  - 签约SP，获得产品代理权                                        │   │
  │   │  - 为商户开通产品                                                │   │
  │   │  - 配置商户费率                                                  │   │
  │   │  - 配置产品路由规则                                              │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ TP给MP开通产品
                                    │ MP只看到产品，不感知SP
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          MP层（使用产品）                                │
  │                                                                         │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │  商户(MP)                                                       │   │
  │   │                                                                 │   │
  │   │  看到的产品（不感知SP）：                                         │   │
  │   │  - 数币收款                                                      │   │
  │   │  - 承兑服务                                                      │   │
  │   │  - 法币出款                                                      │   │
  │   │  - VA收款                                                        │   │
  │   │  - POBO出款                                                      │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 产品与SP对应关系

| 签约SP | 产品                                     | 产品说明            | 能力/方式          |
| ------ | ---------------------------------------- | ------------------- | ------------------ |
| BB     | **数币钱包**（充币，提币）         | 接收USDT/USDC等数币 | 充币、提币         |
| BB     | **法币账户**（法币充值，法币提现） | 法币资金管理        | 充值、提现         |
| BB     | **数币钱包**（提币，提现）         | 数币提取            | 提币、提现         |
| BB     | **承兑服务**                       | 法币付款到银行账户  | 数币→法币         |
| IPL    | **法币账户**（提现）               | 法币资金管理        | 提现               |
| IPL    | **收款**                           | 法币VA账户收款      | VA收款（收款方式） |
| IPL    | **付款**                           | 法币代付出款+POBO   | POBO（付款能力）   |

> **说明**：
>
> - **VA收款**不是独立产品，是"收款"产品下的一种收款方式
> - **POBO**不是独立产品，是"付款"产品下增加的能力

### 2.4 三种业务场景

| 场景            | 商户使用的产品                   | TP签约的SP | 说明                        |
| --------------- | -------------------------------- | ---------- | --------------------------- |
| **场景A** | 数币钱包 + 承兑服务              | BB         | BB内部处理，商户不感知      |
| **场景B** | 数币钱包 + 承兑服务 + 付款(POBO) | BB + IPL   | BB承兑，IPL出款，商户不感知 |
| **场景C** | 收款(VA) + 付款(POBO)            | IPL        | 纯法币业务，商户不感知      |

### 2.5 MVP简化方案

> **核心决策**：MVP阶段只支持IPL+BB，商户看到**统一账户**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MVP账户模型                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【商户视角】                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  我的法币账户：$10,000                                               │   │
│  │  (商户只看到一个统一账户)                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【系统内部】                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  IPL账户：$3,000  ←──┐                                              │   │
│  │                      │ 可内部调拨                                    │   │
│  │  BB账户：$7,000   ←──┘                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【调拨逻辑】                                                                │
│  - 出款时优先从IPL或BB出（根据路由规则）                                      │
│  - IPL和BB定期调拨平账                                                      │
│  - 商户无需感知底层账户分布                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**MVP范围说明**：

| 项目     | MVP支持                  | 后续扩展           |
| -------- | ------------------------ | ------------------ |
| SP范围   | IPL + BB                 | YPay、ZPay等独立SP |
| 账户模型 | 统一账户（IPL+BB可调拨） | 按资金池分组账户   |
| 资金调拨 | IPL↔BB定期调拨          | 独立SP不可调拨     |

### 2.6 "数法融合"定位

> **"数法融合"是解决方案/营销层面的概念，不是商户可见的产品**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         "数法融合"定位                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【对外/营销层面】                                                           │
│  "数法融合"是解决方案的名称，强调数币+法币的融合能力                           │
│                                                                             │
│  【TP层面】                                                                  │
│  TP签约了BB+IPL，就具备"数法融合"能力                                        │
│  TP可以为商户配置使用BB的能力、IPL的能力、或两者组合                          │
│                                                                             │
│  【商户层面】                                                                │
│  商户不感知"数法融合"，只看到具体产品：                                       │
│  - 数币钱包、法币账户、承兑服务（BB提供）                                     │
│  - VA收款、付款（IPL提供）                                                   │
│  商户开通产品后，TP通过路由决定用哪个SP处理                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块一：商户入网与产品开通

### 3.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        商户入网与产品开通模块                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   商户创建       │  │   产品开通       │  │   产品路由配置   │             │
│  │                 │  │                 │  │                 │             │
│  │  - 基本信息录入  │  │  - 选择产品     │  │  - 默认路由规则  │             │
│  │  - KYC/KYB材料  │  │  - 后台SP入网   │  │  - 商户级路由    │             │
│  │  - 业务类型     │  │  - 审核通过     │  │  - 优先级配置    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
│  【核心原则】                                                                │
│  - TP签约SP，代理产品                                                        │
│  - TP给商户开通产品（商户只看到产品名称，不感知SP）                             │
│  - TP配置产品路由规则（决定用哪个SP处理）                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 TP签约SP流程

> **说明**：租户需先与SP签约，获得产品代理权，才能为商户开通对应产品。

```
┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  SP(BB)  │
└────┬─────┘                    └────┬─────┘
     │                               │
     │ 1. 申请签约                    │
     │──────────────────────────────>│
     │                               │
     │                               │ 2. 审核租户资质
     │                               │──┐
     │                               │<─┘
     │                               │
     │ 3. 签约完成                    │
     │    获得产品代理权              │
     │<──────────────────────────────│
     │                               │
     │ 4. 产品列表更新                │
     │    可为商户开通：              │
     │    - 法币收款  
          - 充币                │
     │    - 承兑服务                  │
     │    - 提币
          - 法币出款                  │
     │                              │
```

**TP签约后获得的产品代理权**：

| 签约SP | 产品                           | 产品说明            | 能力/方式          |
| ------ | ------------------------------ | ------------------- | ------------------ |
| BB     | 数币钱包（充币，提币）         | 接收USDT/USDC等数币 | 充币、提币         |
| BB     | 法币账户（法币充值，法币提现） | 法币资金管理        | 充值、提现         |
| BB     | 数币钱包（提币，提现）         | 数币提取            | 提币、提现         |
| BB     | 承兑服务                       | 法币付款到银行账户  | 数币→法币         |
| IPL    | 法币账户（提现）               | 法币资金管理        | 提现               |
| IPL    | 收款                           | 法币VA账户收款      | VA收款（收款方式） |
| IPL    | 付款                           | 法币代付出款+POBO   | POBO（付款能力）   |

### 3.3 商户入网流程（产品驱动）

> **核心逻辑**：
>
> - 商户注册后**先选择产品**，提交产品开通申请（含KYC/KYB资料）
> - 系统根据产品→SP映射，**自动推送到对应SP审核**
> - SP审核通过后，通知商户**产品已开通**
> - **EX不做合规审核**，审核由SP负责；TP无需先审核入网
> - 商户全程不感知SP的存在

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ 商户(MP) │                    │ EX系统   │                    │  SP层    │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │ 1. 注册（基本信息）            │                               │
     │──────────────────────────────>│                               │
     │                               │                               │
     │                               │ 2. 创建MID                    │
     │                               │    状态: REGISTERED            │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │ 3. 注册成功，进入产品选择       │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
     │ 4. 选择产品 + 提交KYC资料      │                               │
     │    (数币钱包/承兑/收款等)      │                               │
     │──────────────────────────────>│                               │
     │                               │                               │
     │                               │ 5. 校验资料完整性              │
     │                               │    查询产品→SP映射             │
     │                               │    自动推送到对应SP             │
     │                               │──────────────────────────────>│
     │                               │                               │
     │                               │                               │ 6. SP审核
     │                               │                               │   (KYC/KYB/
     │                               │                               │    合规/风控)
     │                               │                               │──┐
     │                               │                               │<─┘
     │                               │                               │
     │                               │ 7. SP审核结果                  │
     │                               │<──────────────────────────────│
     │                               │                               │
     │ 8. 通知：产品开通成功           │                               │
     │    (商户可以使用产品了)        │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
```

> **与旧设计的区别**：去掉了"TP先审核入网→再选产品"的两阶段模式。现在是**注册即创建MID → 选产品 → 推送SP审核**，一步到位。EX是科技平台，不做合规审核。

### 3.4 商户选择产品与开通流程

#### 3.4.1 三种产品开通方式

> **产品开通支持三种方式**：商户主动开通、自动开通、TP开通

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         产品开通方式                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【方式一】商户主动开通                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  商户入网通过后，在MP中主动选择需要开通的产品                          │   │
│  │  适用：商户清楚自己的业务需求                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【方式二】自动开通（根据商户资料）                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据商户入网时填写的业务类型、资质材料，系统自动推荐/开通产品          │   │
│  │  适用：标准化业务场景                                                  │   │
│  │                                                                       │   │
│  │  自动开通规则示例：                                                    │   │
│  │  - 业务类型=跨境电商 → 自动开通：数币收款+承兑服务+法币出款             │   │
│  │  - 业务类型=贸易结算 → 自动开通：VA收款+POBO出款                       │   │
│  │  - 有数币钱包地址 → 自动开通：数币收款                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【方式三】TP开通                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  租户在TP后台为商户开通产品                                            │   │
│  │  适用：TP统一管理商户产品配置                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**三种开通方式对比**：

| 开通方式               | 触发者   | 触发时机                         | 适用场景         |
| ---------------------- | -------- | -------------------------------- | ---------------- |
| **商户主动开通** | 商户(MP) | 注册后，商户在MP选择产品         | 商户清楚业务需求 |
| **自动开通**     | 系统     | 注册时，根据商户资料自动开通     | 标准化业务场景   |
| **TP开通**       | 租户(TP) | TP在后台为商户配置产品           | TP统一管理       |

#### 3.4.2 产品驱动流程说明

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     商户注册与产品开通（产品驱动，一步到位）                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌───────────────┐
  │ 1. 商户注册    │  填写基本信息（公司名称、联系人、邮箱等）
  │                │  ⚡ 注册即创建MID，无需等待审核
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 2. 选择产品    │  三种方式任选其一：
  │    + 提交资料  │  - 商户主动选择产品
  │                │  - 系统根据资料自动开通
  │                │  - TP在后台为商户开通
  │                │  同时提交KYC/KYB资料
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 3. 系统自动    │  根据产品→SP映射，自动向对应SP推送入网申请
  │    推送SP      │  （商户不感知此步骤）
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 4. SP审核     │  SP负责KYC/KYB/合规/风控审核
  │                │  EX不做合规审核
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 5. 产品开通    │  ★ 通知商户：产品已开通
  │    通知商户    │    商户可以使用产品了
  └───────────────┘
```

#### 3.4.2 商户视角的通知

| 通知               | 触发时机           | 通知内容                            | 商户可操作 |
| ------------------ | ------------------ | ----------------------------------- | ---------- |
| **产品开通通知** | SP审核产品开通通过 | "产品已开通：数币钱包、承兑服务..." | 使用产品   |

> **说明**：不再有"入网审核通过"的独立通知。商户注册后直接选产品，SP审核通过即产品开通，只有一次通知。

#### 3.4.3 商户选择产品界面（示意）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           选择开通产品                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  您的入网审核已通过，请选择需要开通的产品：                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  【BB产品】                                                         │   │
│  │  ☑ 数币钱包（充币，提币）                                            │   │
│  │     接收USDT/USDC等数字货币                                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☑ 法币账户（法币充值，法币提现）                                     │   │
│  │     法币资金管理                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☑ 承兑服务                                                         │   │
│  │     数字货币兑换为法币，付款到银行账户                                 │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  【IPL产品】                                                        │   │
│  │  ☐ 法币账户（提现）                                                  │   │
│  │     法币资金管理                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☐ 收款                                                             │   │
│  │     法币VA账户收款                                                   │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☐ 付款                                                             │   │
│  │     法币代付出款+POBO                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│                              [ 提交申请 ]                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.4.4 产品与SP入网映射

| 商户开通的产品         | 系统自动触发的SP入网 | 说明                  |
| ---------------------- | -------------------- | --------------------- |
| 数币钱包（充币，提币） | BB入网               | 需要BB的数币钱包能力  |
| 法币账户（BB）         | BB入网               | 需要BB的法币账户能力  |
| 数币钱包（提币，提现） | BB入网               | 需要BB的数币钱包能力  |
| 承兑服务               | BB入网               | 需要BB的承兑引擎      |
| 法币账户（IPL）        | IPL入网              | 需要IPL的法币账户能力 |
| 收款                   | IPL入网              | 需要IPL的VA收款能力   |
| 付款                   | IPL入网              | 需要IPL的POBO能力     |

#### 3.4.5 商户视角 vs TP视角

| 视角               | 看到的内容                       | 操作权限           |
| ------------------ | -------------------------------- | ------------------ |
| **商户(MP)** | 产品名称（数币收款、承兑服务等） | 使用产品           |
| **租户(TP)** | 产品名称 + 底层SP + 路由规则     | 开通产品、配置路由 |

### 3.5 产品路由配置

> **说明**：当一个产品可由多个SP提供时（如法币出款可由BB或IPL提供），TP需配置路由规则决定使用哪个SP。

#### 3.5.1 路由配置流程

```
┌──────────┐
│ 租户(TP) │
└────┬─────┘
     │
     │ 1. 进入产品路由配置
     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           产品路由配置界面                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  产品：法币出款                                                              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  默认路由规则（租户级）                                              │   │
│  │                                                                     │   │
│  │  ○ BB法币出款（优先级1）                                             │   │
│  │  ○ IPL POBO出款（优先级2）                                           │   │
│  │                                                                     │   │
│  │  路由条件：                                                          │   │
│  │  - 币种：USD → BB                                                   │   │
│  │  - 币种：HKD → IPL                                                  │   │
│  │  - 金额 > 10万 → IPL                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  商户级路由规则（覆盖默认）                                           │   │
│  │                                                                     │   │
│  │  商户A：固定使用 IPL POBO出款                                        │   │
│  │  商户B：固定使用 BB法币出款                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.5.2 路由规则类型

| 规则类型             | 说明                 | 示例                       |
| -------------------- | -------------------- | -------------------------- |
| **默认路由**   | 租户级默认规则       | 所有商户默认使用BB法币出款 |
| **商户级路由** | 针对特定商户的规则   | 商户A固定使用IPL POBO      |
| **条件路由**   | 根据交易属性动态路由 | USD用BB，HKD用IPL          |
| **优先级路由** | 按优先级尝试         | 优先BB，失败则用IPL        |

#### 3.5.3 路由决策流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           路由决策流程                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  交易请求
      │
      ▼
  ┌─────────────────┐
  │ 1. 检查商户级路由 │
  └────────┬────────┘
           │
     有商户级规则？
      ┌────┴────┐
      │是       │否
      ▼         ▼
  使用商户级   ┌─────────────────┐
  路由规则    │ 2. 检查条件路由  │
              └────────┬────────┘
                       │
                 匹配条件？
                  ┌────┴────┐
                  │是       │否
                  ▼         ▼
              使用条件   ┌─────────────────┐
              路由规则   │ 3. 使用默认路由  │
                        └────────┬────────┘
                                 │
                                 ▼
                            选择SP执行
```

### 3.6 数据表结构

#### 3.6.1 商户表 (t_merchant)

| 字段名        | 类型         | 必填 | 说明                                  |
| ------------- | ------------ | ---- | ------------------------------------- |
| id            | bigint       | 是   | 主键                                  |
| merchant_no   | varchar(32)  | 是   | 商户编号                              |
| merchant_name | varchar(128) | 是   | 商户名称                              |
| tenant_id     | bigint       | 是   | 所属租户ID                            |
| business_type | varchar(32)  | 是   | 业务类型: FOREIGN_TRADE/SERVICE_TRADE |
| status        | varchar(16)  | 是   | 状态: PENDING/ACTIVE/SUSPENDED        |
| created_at    | datetime     | 是   | 创建时间                              |
| updated_at    | datetime     | 是   | 更新时间                              |

#### 3.6.2 商户产品开通表 (t_merchant_product)

> **说明**：记录商户开通的产品，商户只看到产品，不感知SP

| 字段名       | 类型        | 必填 | 说明                                                                                        |
| ------------ | ----------- | ---- | ------------------------------------------------------------------------------------------- |
| id           | bigint      | 是   | 主键                                                                                        |
| merchant_id  | bigint      | 是   | 商户ID                                                                                      |
| product_code | varchar(32) | 是   | 产品代码: BB_CRYPTO_WALLET/BB_FIAT_ACCOUNT/BB_EXCHANGE/IPL_FIAT_ACCOUNT/IPL_COLLECT/IPL_PAY |
| product_name | varchar(64) | 是   | 产品名称（商户可见）: 数币钱包/法币账户/承兑服务/收款/付款                                  |
| sp_code      | varchar(16) | 是   | 所属SP: BB/IPL                                                                              |
| open_type    | varchar(16) | 是   | 开通方式: MERCHANT_ACTIVE/AUTO/TP_ACTIVE                                                    |
| open_by      | varchar(64) | 否   | 开通操作人（TP开通时记录操作员）                                                            |
| status       | varchar(16) | 是   | 状态: PENDING/ACTIVE/SUSPENDED                                                              |
| created_at   | datetime    | 是   | 创建时间                                                                                    |
| updated_at   | datetime    | 是   | 更新时间                                                                                    |

**开通方式枚举**：

| 枚举值          | 说明                         |
| --------------- | ---------------------------- |
| MERCHANT_ACTIVE | 商户主动开通                 |
| AUTO            | 系统自动开通（根据商户资料） |
| TP_ACTIVE       | TP开通                       |

#### 3.6.3 商户SP入网表 (t_merchant_sp_onboarding)

> **说明**：记录商户在各SP的入网状态，商户不可见，仅TP和系统可见

| 字段名         | 类型         | 必填 | 说明                            |
| -------------- | ------------ | ---- | ------------------------------- |
| id             | bigint       | 是   | 主键                            |
| merchant_id    | bigint       | 是   | 商户ID                          |
| sp_code        | varchar(32)  | 是   | SP代码: BB/IPL                  |
| sp_merchant_id | varchar(64)  | 否   | SP侧商户ID                      |
| status         | varchar(16)  | 是   | 状态: PENDING/APPROVED/REJECTED |
| audit_comment  | varchar(512) | 否   | 审核意见                        |
| approved_at    | datetime     | 否   | 审核通过时间                    |
| created_at     | datetime     | 是   | 创建时间                        |

#### 3.6.4 产品路由配置表 (t_product_routing)

> **说明**：记录产品的路由规则，决定使用哪个SP处理

| 字段名          | 类型         | 必填 | 说明                              |
| --------------- | ------------ | ---- | --------------------------------- |
| id              | bigint       | 是   | 主键                              |
| tenant_id       | bigint       | 是   | 租户ID                            |
| merchant_id     | bigint       | 否   | 商户ID（为空表示租户级规则）      |
| product_code    | varchar(32)  | 是   | 产品代码                          |
| sp_code         | varchar(32)  | 是   | 路由到的SP: BB/IPL                |
| priority        | int          | 是   | 优先级（数字越小优先级越高）      |
| condition_type  | varchar(32)  | 否   | 条件类型: CURRENCY/AMOUNT/COUNTRY |
| condition_value | varchar(128) | 否   | 条件值: USD/HKD 或 >100000        |
| status          | varchar(16)  | 是   | 状态: ACTIVE/INACTIVE             |
| created_at      | datetime     | 是   | 创建时间                          |
| updated_at      | datetime     | 是   | 更新时间                          |

#### 3.6.5 租户SP签约表 (t_tenant_sp_contract)

> **说明**：记录租户与SP的签约关系，决定租户可代理哪些产品

| 字段名         | 类型        | 必填 | 说明                              |
| -------------- | ----------- | ---- | --------------------------------- |
| id             | bigint      | 是   | 主键                              |
| tenant_id      | bigint      | 是   | 租户ID                            |
| sp_code        | varchar(32) | 是   | SP代码: BB/IPL                    |
| contract_no    | varchar(64) | 否   | 合同编号                          |
| status         | varchar(16) | 是   | 状态: ACTIVE/SUSPENDED/TERMINATED |
| effective_date | date        | 是   | 生效日期                          |
| expiry_date    | date        | 否   | 到期日期                          |
| created_at     | datetime    | 是   | 创建时间                          |

#### 3.6.6 产品自动开通规则表 (t_product_auto_open_rule)

> **说明**：配置根据商户资料自动开通产品的规则

| 字段名          | 类型         | 必填 | 说明                                      |
| --------------- | ------------ | ---- | ----------------------------------------- |
| id              | bigint       | 是   | 主键                                      |
| tenant_id       | bigint       | 是   | 租户ID                                    |
| rule_name       | varchar(64)  | 是   | 规则名称                                  |
| condition_type  | varchar(32)  | 是   | 条件类型: BUSINESS_TYPE/HAS_CRYPTO_WALLET |
| condition_value | varchar(128) | 是   | 条件值: CROSS_BORDER_ECOMMERCE/TRUE       |
| product_codes   | varchar(256) | 是   | 自动开通的产品代码（逗号分隔）            |
| priority        | int          | 是   | 优先级（数字越小优先级越高）              |
| status          | varchar(16)  | 是   | 状态: ACTIVE/INACTIVE                     |
| created_at      | datetime     | 是   | 创建时间                                  |

**自动开通规则示例**：

| 规则名称     | 条件类型          | 条件值                 | 自动开通产品                        |
| ------------ | ----------------- | ---------------------- | ----------------------------------- |
| 跨境电商套餐 | BUSINESS_TYPE     | CROSS_BORDER_ECOMMERCE | CRYPTO_COLLECT,EXCHANGE,FIAT_PAYOUT |
| 贸易结算套餐 | BUSINESS_TYPE     | TRADE_SETTLEMENT       | VA_COLLECT,POBO                     |
| 数币用户     | HAS_CRYPTO_WALLET | TRUE                   | CRYPTO_COLLECT                      |

---

## 4. 模块二：租户配置

### 4.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           租户配置模块                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   费率配置       │  │   SP能力配置    │  │   出款规则配置   │             │
│  │                 │  │                 │  │                 │             │
│  │  - 商户费率      │  │  - 收款能力     │  │  - 异名出款规则  │             │
│  │  - 费率类型      │  │  - 出款能力     │  │  - 错名出款规则  │             │
│  │  - 扣费方式      │  │  - 默认SP选择   │  │  - 限额配置      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 费率配置流程

```
┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  SP(BB)  │
└────┬─────┘                    └────┬─────┘
     │                               │
     │ 1. 查询SP底价                  │
     │──────────────────────────────>│
     │                               │
     │ 2. 返回底价信息                │
     │<──────────────────────────────│
     │                               │
     │ 3. 配置商户费率                │
     │    (不得低于底价)              │
     │──────────────────────────────>│
     │                               │
     │                               │ 4. 费率校验
     │                               │──┐
     │                               │  │
     │                               │<─┘
     │                               │
     │ 5. 配置结果通知                │
     │<──────────────────────────────│
     │                               │
```

### 4.3 费率层级结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              费率层级                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  SP底价 (BB/IPL成本价)                                              │   │
│   │  - 由SP设定，租户不可修改                                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  租户费率                                                           │   │
│   │  - 租户在底价基础上加价                                              │   │
│   │  - 不得低于SP底价                                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  商户费率                                                           │   │
│   │  - 租户为商户配置的最终费率                                          │   │
│   │  - 不得低于租户费率                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 费率类型与扣费方式

**费率类型**：

| 类型       | 说明                 | 示例                      |
| ---------- | -------------------- | ------------------------- |
| 百分比费率 | 按交易金额百分比收取 | 1.5%                      |
| 固定费用   | 每笔交易固定金额     | 5 USD/笔                  |
| 阶梯费率   | 按交易量分段计费     | 0-10万: 1.5%, 10万+: 1.2% |
| 混合费率   | 百分比+固定费用      | 1% + 2 USD                |

**扣费方式**：

| 方式           | 说明             | 计算示例                     |
| -------------- | ---------------- | ---------------------------- |
| **内扣** | 从交易金额中扣除 | 交易1000，费率1%，实收990    |
| 外扣           | 从账户余额中扣除 | 交易1000，实收1000，账户扣10 |

### 4.5 SP能力配置

租户为商户配置使用哪个SP的能力：

| 配置项   | 可选值            | 说明                       |
| -------- | ----------------- | -------------------------- |
| 收款能力 | BB收款 / IPL VA   | 选择数币收款还是法币VA收款 |
| 出款能力 | BB出款 / IPL POBO | 选择BB出款还是IPL代付      |

> **注意**：BB内部使用大账户还是XPAY渠道，由BB内部决定，对租户透明。

### 4.6 出款规则配置

| 规则       | 说明                 | 配置项                 |
| ---------- | -------------------- | ---------------------- |
| 异名出款   | 出款人与收款人不同名 | 是否允许、是否需审核   |
| 错名出款   | 收款人名称有差异     | 容忍度阈值、是否需审核 |
| 单笔限额   | 单笔交易限额         | 最小/最大金额          |
| 日累计限额 | 日累计交易限额       | 最大累计金额           |

### 4.7 数据表结构

#### 4.7.1 费率配置表 (t_fee_config)

| 字段名         | 类型          | 必填 | 说明                                 |
| -------------- | ------------- | ---- | ------------------------------------ |
| id             | bigint        | 是   | 主键                                 |
| merchant_id    | bigint        | 是   | 商户ID                               |
| fee_type       | varchar(32)   | 是   | 费率类型: PERCENT/FIXED/TIERED/MIXED |
| fee_value      | decimal(10,4) | 是   | 费率值（百分比或固定金额）           |
| fee_config     | json          | 否   | 复杂费率配置（阶梯费率等）           |
| deduct_type    | varchar(16)   | 是   | 扣费方式: INTERNAL/EXTERNAL          |
| effective_time | datetime      | 是   | 生效时间                             |
| status         | varchar(16)   | 是   | 状态: PENDING/ACTIVE/EXPIRED         |
| created_at     | datetime      | 是   | 创建时间                             |

#### 4.7.2 商户SP配置表 (t_merchant_sp_config)

| 字段名               | 类型          | 必填 | 说明             |
| -------------------- | ------------- | ---- | ---------------- |
| id                   | bigint        | 是   | 主键             |
| merchant_id          | bigint        | 是   | 商户ID           |
| collect_sp           | varchar(32)   | 是   | 收款SP: BB/IPL   |
| payout_sp            | varchar(32)   | 是   | 出款SP: BB/IPL   |
| allow_different_name | tinyint       | 是   | 是否允许异名出款 |
| allow_fuzzy_name     | tinyint       | 是   | 是否允许错名出款 |
| fuzzy_threshold      | decimal(3,2)  | 否   | 错名容忍度阈值   |
| single_limit         | decimal(18,2) | 否   | 单笔限额         |
| daily_limit          | decimal(18,2) | 否   | 日累计限额       |
| created_at           | datetime      | 是   | 创建时间         |
| updated_at           | datetime      | 是   | 更新时间         |

---

## 5. 模块三：交易处理

### 5.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           交易处理模块                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   数币收款       │  │   承兑处理       │  │   法币出款       │             │
│  │                 │  │                 │  │                 │             │
│  │  - 地址分配      │  │  - 汇率锁定     │  │  - 出款申请      │             │
│  │  - 到账确认      │  │  - 数币→法币    │  │  - 异名/错名审核  │             │
│  │  - 金额核对      │  │  - 费用计算     │  │  - 本地/跨境出款  │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │   退款处理       │  │   交易查询       │                                  │
│  │                 │  │                 │                                  │
│  │  - 退款申请      │  │  - 交易列表     │                                  │
│  │  - 退款审核      │  │  - 交易详情     │                                  │
│  │  - 原路退回      │  │  - 数据导出     │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 完整交易时序图

#### 5.2.1 场景A：BB承兑交易（数币收款→承兑→法币出款）

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────┐
│ 商户(MP) │    │ 租户(TP) │    │  BB(SP)  │    │ BB内部Channel │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └──────┬───────┘
     │               │               │                 │
     │ 1. 发起收款请求│               │                 │
     │──────────────>│               │                 │
     │               │               │                 │
     │               │ 2. 创建交易   │                 │
     │               │──────────────>│                 │
     │               │               │                 │
     │               │ 3. 返回收款地址│                 │
     │               │<──────────────│                 │
     │               │               │                 │
     │ 4. 返回收款信息│               │                 │
     │<──────────────│               │                 │
     │               │               │                 │
     │ 5. 买家转入数币│               │                 │
     │─────────────────────────────>│                 │
     │               │               │                 │
     │               │               │ 6. 数币到账确认 │
     │               │               │──┐              │
     │               │               │  │              │
     │               │               │<─┘              │
     │               │               │                 │
     │               │ 7. 到账通知   │                 │
     │               │<──────────────│                 │
     │               │               │                 │
     │               │               │ 8. 承兑处理     │
     │               │               │    (数币→法币)  │
     │               │               │──┐              │
     │               │               │  │              │
     │               │               │<─┘              │
     │               │               │                 │
     │ 9. 发起出款请求│               │                 │
     │──────────────>│               │                 │
     │               │               │                 │
     │               │ 10. 出款申请  │                 │
     │               │──────────────>│                 │
     │               │               │                 │
     │               │               │ 11. 选择Channel │
     │               │               │    (内部决策)   │
     │               │               │────────────────>│
     │               │               │                 │
     │               │               │ 12. 执行出款    │
     │               │               │<────────────────│
     │               │               │                 │
     │               │ 13. 出款结果  │                 │
     │               │<──────────────│                 │
     │               │               │                 │
     │ 14. 出款完成通知               │                 │
     │<──────────────│               │                 │
     │               │               │                 │
```

#### 5.2.2 场景B：BB+IPL联合交易

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 商户(MP) │    │ 租户(TP) │    │  BB(SP)  │    │  IPL(SP) │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     │ 1. 发起收款请求│               │               │
     │──────────────>│               │               │
     │               │               │               │
     │               │ 2. 创建交易   │               │
     │               │──────────────>│               │
     │               │               │               │
     │               │ 3. 返回收款地址│               │
     │               │<──────────────│               │
     │               │               │               │
     │ 4. 返回收款信息│               │               │
     │<──────────────│               │               │
     │               │               │               │
     │ 5. 买家转入数币│               │               │
     │─────────────────────────────>│               │
     │               │               │               │
     │               │               │ 6. 数币到账   │
     │               │               │──┐            │
     │               │               │<─┘            │
     │               │               │               │
     │               │               │ 7. 承兑处理   │
     │               │               │──┐            │
     │               │               │<─┘            │
     │               │               │               │
     │ 8. 发起出款请求│               │               │
     │──────────────>│               │               │
     │               │               │               │
     │               │ 9. 出款申请   │               │
     │               │──────────────>│               │
     │               │               │               │
     │               │               │ 10. 调用IPL出款│
     │               │               │──────────────>│
     │               │               │               │
     │               │               │               │ 11. IPL执行POBO
     │               │               │               │──┐
     │               │               │               │<─┘
     │               │               │               │
     │               │               │ 12. 出款结果  │
     │               │               │<──────────────│
     │               │               │               │
     │               │ 13. 出款结果  │               │
     │               │<──────────────│               │
     │               │               │               │
     │ 14. 出款完成通知               │               │
     │<──────────────│               │               │
     │               │               │               │
```

### 5.3 交易状态机

```
┌─────────┐
│ CREATED │ 交易创建
└────┬────┘
     │
     ▼
┌─────────┐
│ PENDING │ 等待数币到账
└────┬────┘
     │
     ▼
┌──────────┐
│ RECEIVED │ 数币已到账
└────┬─────┘
     │
     ▼
┌────────────┐
│ EXCHANGING │ 承兑处理中
└─────┬──────┘
      │
      ▼
┌───────────┐
│ EXCHANGED │ 承兑完成
└─────┬─────┘
      │
      ▼
┌────────────┐
│ PAYING_OUT │ 出款中
└─────┬──────┘
      │
  ┌───┴───┐
  ▼       ▼
┌───────┐ ┌────────┐
│SUCCESS│ │ FAILED │
└───────┘ └────────┘
```

### 5.4 退款流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 商户(MP) │    │ 租户(TP) │    │  BB(SP)  │    │  IPL(SP) │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     │ 1. 发起退款申请│               │               │
     │──────────────>│               │               │
     │               │               │               │
     │               │ 2. 退款审核   │               │
     │               │──┐            │               │
     │               │<─┘            │               │
     │               │               │               │
     │               │ 3. 提交退款   │               │
     │               │──────────────>│               │
     │               │               │               │
     │               │               │ 4. 判断退款方式│
     │               │               │──┐            │
     │               │               │<─┘            │
     │               │               │               │
     │               │               │ [BB退款: 数币退回]
     │               │               │──┐            │
     │               │               │<─┘            │
     │               │               │               │
     │               │               │ [IPL退款: 法币退回]
     │               │               │──────────────>│
     │               │               │               │
     │               │               │ 5. 退款结果   │
     │               │               │<──────────────│
     │               │               │               │
     │               │ 6. 退款结果   │               │
     │               │<──────────────│               │
     │               │               │               │
     │ 7. 退款完成通知│               │               │
     │<──────────────│               │               │
     │               │               │               │
```

### 5.5 数据表结构

#### 5.5.1 交易表 (t_transaction)

| 字段名        | 类型          | 必填 | 说明                             |
| ------------- | ------------- | ---- | -------------------------------- |
| id            | bigint        | 是   | 主键                             |
| tx_no         | varchar(32)   | 是   | 交易编号                         |
| merchant_id   | bigint        | 是   | 商户ID                           |
| tenant_id     | bigint        | 是   | 租户ID                           |
| tx_type       | varchar(16)   | 是   | 交易类型: EXCHANGE/PAYOUT/REFUND |
| crypto_type   | varchar(16)   | 是   | 数币类型: USDT/USDC              |
| crypto_amount | decimal(18,8) | 是   | 数币金额                         |
| fiat_currency | varchar(8)    | 是   | 法币币种                         |
| fiat_amount   | decimal(18,2) | 是   | 法币金额                         |
| exchange_rate | decimal(18,6) | 是   | 汇率                             |
| fee_amount    | decimal(18,2) | 是   | 手续费                           |
| net_amount    | decimal(18,2) | 是   | 实收金额                         |
| status        | varchar(16)   | 是   | 交易状态                         |
| collect_sp    | varchar(32)   | 是   | 收款SP                           |
| payout_sp     | varchar(32)   | 否   | 出款SP                           |
| created_at    | datetime      | 是   | 创建时间                         |
| updated_at    | datetime      | 是   | 更新时间                         |

#### 5.5.2 出款表 (t_payout)

| 字段名              | 类型          | 必填 | 说明         |
| ------------------- | ------------- | ---- | ------------ |
| id                  | bigint        | 是   | 主键         |
| payout_no           | varchar(32)   | 是   | 出款编号     |
| tx_id               | bigint        | 是   | 关联交易ID   |
| merchant_id         | bigint        | 是   | 商户ID       |
| amount              | decimal(18,2) | 是   | 出款金额     |
| currency            | varchar(8)    | 是   | 币种         |
| beneficiary_name    | varchar(128)  | 是   | 收款人姓名   |
| beneficiary_account | varchar(64)   | 是   | 收款账号     |
| beneficiary_bank    | varchar(128)  | 是   | 收款银行     |
| is_different_name   | tinyint       | 是   | 是否异名出款 |
| is_fuzzy_name       | tinyint       | 是   | 是否错名出款 |
| status              | varchar(16)   | 是   | 状态         |
| sp_code             | varchar(32)   | 是   | 出款SP       |
| sp_payout_id        | varchar(64)   | 否   | SP侧出款ID   |
| created_at          | datetime      | 是   | 创建时间     |
| completed_at        | datetime      | 否   | 完成时间     |

#### 5.5.3 退款表 (t_refund)

| 字段名          | 类型          | 必填 | 说明                  |
| --------------- | ------------- | ---- | --------------------- |
| id              | bigint        | 是   | 主键                  |
| refund_no       | varchar(32)   | 是   | 退款编号              |
| tx_id           | bigint        | 是   | 原交易ID              |
| merchant_id     | bigint        | 是   | 商户ID                |
| refund_type     | varchar(16)   | 是   | 退款类型: CRYPTO/FIAT |
| refund_amount   | decimal(18,2) | 是   | 退款金额              |
| refund_currency | varchar(8)    | 是   | 退款币种              |
| reason          | varchar(256)  | 是   | 退款原因              |
| status          | varchar(16)   | 是   | 状态                  |
| sp_code         | varchar(32)   | 是   | 退款SP                |
| created_at      | datetime      | 是   | 创建时间              |
| completed_at    | datetime      | 否   | 完成时间              |

---

## 6. 模块四：对账清算

### 6.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           对账清算模块                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   交易对账       │  │   费用结算       │  │   账单生成       │             │
│  │                 │  │                 │  │                 │             │
│  │  - 数据核对      │  │  - 费用计算     │  │  - 商户账单      │             │
│  │  - 差异处理      │  │  - 分润结算     │  │  - 租户账单      │             │
│  │  - 对账报告      │  │  - 结算周期     │  │  - 账单下载      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 对账流程

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  BB(SP)  │                    │  IPL(SP) │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │                               │ 1. 日终对账任务               │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │                               │ 2. 获取IPL交易数据            │
     │                               │──────────────────────────────>│
     │                               │                               │
     │                               │ 3. 返回交易数据               │
     │                               │<──────────────────────────────│
     │                               │                               │
     │                               │ 4. 数据核对                   │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │                               │ 5. 生成对账报告               │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │ 6. 推送对账结果               │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
```

### 6.3 费用分润模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              费用分润                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  商户支付总费用 = 100 USD
       │
       ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                      费用拆分                               │
  │                                                             │
  │   ┌───────────────┐   ┌───────────────┐                    │
  │   │   SP成本       │   │   租户利润     │                    │
  │   │  (BB+IPL底价)  │   │  (租户加价)    │                    │
  │   │   70 USD       │   │   30 USD       │                    │
  │   └───────────────┘   └───────────────┘                    │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘
```

### 6.4 数据表结构

#### 6.4.1 对账记录表 (t_reconciliation)

| 字段名          | 类型          | 必填 | 说明                            |
| --------------- | ------------- | ---- | ------------------------------- |
| id              | bigint        | 是   | 主键                            |
| recon_date      | date          | 是   | 对账日期                        |
| tenant_id       | bigint        | 是   | 租户ID                          |
| sp_code         | varchar(32)   | 是   | SP代码                          |
| total_tx_count  | int           | 是   | 总交易笔数                      |
| total_amount    | decimal(18,2) | 是   | 总交易金额                      |
| matched_count   | int           | 是   | 匹配笔数                        |
| unmatched_count | int           | 是   | 不匹配笔数                      |
| status          | varchar(16)   | 是   | 状态: PENDING/MATCHED/EXCEPTION |
| created_at      | datetime      | 是   | 创建时间                        |

#### 6.4.2 账单表 (t_bill)

| 字段名         | 类型          | 必填 | 说明                      |
| -------------- | ------------- | ---- | ------------------------- |
| id             | bigint        | 是   | 主键                      |
| bill_no        | varchar(32)   | 是   | 账单编号                  |
| bill_type      | varchar(16)   | 是   | 账单类型: MERCHANT/TENANT |
| target_id      | bigint        | 是   | 商户ID或租户ID            |
| bill_period    | varchar(16)   | 是   | 账单周期: 2026-01         |
| total_tx_count | int           | 是   | 总交易笔数                |
| total_amount   | decimal(18,2) | 是   | 总交易金额                |
| total_fee      | decimal(18,2) | 是   | 总手续费                  |
| status         | varchar(16)   | 是   | 状态                      |
| created_at     | datetime      | 是   | 创建时间                  |

---

## 7. 附录：需求清单

| 序号 | 需求描述              | 优先级 | 对应模块          |
| ---- | --------------------- | ------ | ----------------- |
| 1    | 租户可以看到交易      | P1     | 模块三-交易查询   |
| 2    | 租户可以配置商户费率  | P0     | 模块二-费率配置   |
| 3    | 交易收费-支持内扣     | P0     | 模块二-扣费方式   |
| 4    | 支持异名出款          | P0     | 模块三-法币出款   |
| 5    | 支持本地出款          | P0     | 模块三-法币出款   |
| 6    | 支持错名出款          | P1     | 模块三-法币出款   |
| 7    | 产品开通补充字段      | P2     | 模块一-商户入网   |
| 8    | 退款流程              | P1     | 模块三-退款处理   |
| 9    | 收款/出款渠道灵活配置 | P2     | 模块二-SP能力配置 |

---

*文档版本：v2.0*
*创建日期：2026-01-31*
*最后更新：2026-01-31*
