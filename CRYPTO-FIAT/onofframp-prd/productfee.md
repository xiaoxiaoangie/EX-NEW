# 产品计费方案设计

## 文档概述

本文档详细描述了EX平台的产品计费体系，包括：

- 产品分类和计费模型
- 费率配置层级（SP阶梯价→TP→商户）
- 计费规则和计算逻辑
- 分润结算流程

**核心设计理念：**

- ✅ **灵活计费**：支持固定费+比例费，支持封顶封底
- ✅ **阶梯定价**：SP对TP提供阶梯价，TP对商户灵活定价
- ✅ **最低报价保护**：SP可设定商户最低报价（Floor Price），TP不可突破
- ✅ **分步计费**：每个环节独立计费，透明清晰
- ✅ **多币种支持**：固定费支持USD，比例费按交易币种
- ✅ **商户友好**：MVP期间不暴露SP，统一费率展示

---

## 目录

1. [产品分类和计费模型](#产品分类和计费模型)
2. [费率配置层级](#费率配置层级)
3. [计费规则详解](#计费规则详解)
4. [完整交易计费示例](#完整交易计费示例)
5. [计费流程时序图](#计费流程时序图)
7. [分润结算逻辑](#分润结算逻辑)

---

## 产品分类和计费模型

### 1.1 产品分类

#### **产品1：数币钱包（Crypto Wallet）**

- **功能**：充币、提币、余额管理
- **开通规则**：开通任何数币相关产品时自动开通
- **计费项**：

  - 充币费（Deposit Fee）
  - 提币费（Withdrawal Fee）

#### **产品2：法币账户（Crypto Wallet）**

- **功能**：充值，提现
- **开通规则**：开通任何数币相关产品时自动开通
- **计费项**：

  - 充值费—— 收款的费用
  - 提现费—— 付款的费用

#### **产品3：Onramp（法币账户→数币钱包）**

- **功能**：法币 → 承兑 → 数币； BB自己+AB组合
- **计费项**：
  - 承兑手续费

#### **产品4：Offramp（数币钱包→法币账户）**

- **功能**：数币 → 承兑 → 法币；BB自己+AB组合
- **计费项**：
  - 承兑费

#### **产品5：收款（Collection—— IPL）**

- **功能**：非同名收款
- **开通规则**：开通任何法币相关产品时自动开通
- **计费项**：

  - VA 费，收款交易的费用—— 参考收款费用

#### **产品5：付款（Payout——IPL）**

- **功能**：非同名收款
- **开通规则**：开通任何法币相关产品时自动开通
- **计费项**：
  - VA 费，收款交易的费用—— 参考收款费用

---

### 1.2 计费模型

**支持的计费方式：**

#### **方式1：固定费（Fixed Fee）**

```
每笔固定金额，如：5 USD/笔
支持币种：USD（本期）
```

#### **方式2：比例费（Percentage Fee）**

```
按交易金额的百分比，如：0.5%
支持封顶（Cap）和封底（Floor）
```

#### **方式3：混合模式（Fixed + Percentage）**

```
固定费 + 比例费，如：2 USD + 0.3%
两项费用相加
```

#### **方式4：阶梯定价（Tiered Pricing）**

```
根据交易金额或交易量，不同阶梯不同费率
适用于：SP对TP的报价，EX对TP的报价
```

---

## 费率配置层级

### 2.1 四层费率结构

```
① SP成本价 (SP Cost Price)
   SP提供给TP的结算价格，SP与TP之间可能是加价模式或返点模式
        │
        ▼
② SP商户最低报价 (SP Merchant Floor Price) ⭐
   SP设定的商户最终费率下限，TP不可修改、不可突破
   无论SP与TP是加价还是返点，商户费率都不能低于此值
        │
        ▼
③ 租户费率 (TP Price)
   TP在SP商户最低报价基础上定价，不得低于②
        │
        ▼
④ 商户费率 (Merchant Price)
   TP为商户配置的最终费率，不得低于③，系统校验 ≥ ②
```

### 2.2 SP商户最低报价（Floor Price）详解

**定义**：SP针对每个产品/计费项设定的商户最终费率下限。TP给商户配置费率时，系统自动校验不得低于此值。

**为什么需要Floor Price？**

SP与TP之间可能采用返点模式（SP按交易量给TP返佣金），在这种模式下：
- SP给TP的"成本价"可能很低甚至为0（因为利润通过返点体现）
- 如果没有Floor Price，TP可能给商户配置极低费率来抢客户
- Floor Price确保商户最终费率不会低于SP的定价底线

**配置示例：**

| 产品 | 计费项 | SP成本价(给TP) | SP返点(给TP) | SP商户最低报价 | TP可给商户报价范围 |
|------|--------|---------------|-------------|--------------|------------------|
| 数币钱包 | 充币费 | 0.1% | 0.05% | 0.3% | ≥ 0.3% |
| 数币钱包 | 提币费 | 5 USDT/笔 | 1 USDT/笔 | 8 USDT/笔 | ≥ 8 USDT/笔 |
| 承兑服务 | 承兑费 | 0.5% | 0.2% | 1.0% | ≥ 1.0% |
| 收款(IPL) | VA收款费 | 0.3% | - | 0.5% | ≥ 0.5% |
| 付款(IPL) | POBO付款费 | 3 USD/笔 | - | 5 USD/笔 | ≥ 5 USD/笔 |

**系统校验规则：**

```
TP配置商户费率时：
  if 商户费率 < SP商户最低报价:
      ❌ 拒绝保存，提示"费率不得低于SP最低报价 X%"
  else:
      ✅ 保存成功
```

**SP与TP的两种合作模式：**

| 合作模式 | SP成本价 | SP商户最低报价 | TP利润来源 | 说明 |
|---------|---------|--------------|-----------|------|
| **加价模式** | SP给TP底价 | SP设定Floor Price | TP在底价上加价，差价即利润 | TP报价 ≥ Floor Price |
| **返点模式** | SP给TP标准价 | SP设定Floor Price | SP按交易量返点/佣金给TP | TP报价 ≥ Floor Price，SP额外返点 |

> **关键约束**：无论哪种合作模式，TP给商户配置的费率都必须 ≥ SP商户最低报价。

---

*最后更新：2026-02-11*
*文档版本：v1.1 — 新增SP商户最低报价（Floor Price）*
