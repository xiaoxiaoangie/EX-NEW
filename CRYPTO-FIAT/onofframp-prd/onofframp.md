# 基于IPL和BB能力的承兑产品设计文档

## 文档信息

| 项目     | 内容                 |
| -------- | -------------------- |
| 文档版本 | v2.0                 |
| 创建日期 | 2026-01-31           |
| 文档状态 | 草稿                 |
| 产品名称 | 数法融合承兑解决方案 |
| MVP范围  | IPL + BB（统一账户） |

---

## 目录

1. [文档背景](#1-文档背景)
2. [业务模块概览](#2-业务模块概览)
   - 2.5 [MVP简化方案](#25-mvp简化方案)
   - 2.6 [&#34;](#26-数法融合定位)数法承兑方案
3. [模块一：商户入网与产品开通](#3-模块一商户入网与产品开通)
   - 3.4.1 [三种产品开通方式](#341-三种产品开通方式)
4. [模块二：租户配置](#4-模块二租户配置)
5. [模块三：交易处理](#5-模块三交易处理)
6. [模块四：对账清算](#6-模块四对账清算)
7. [附录：需求清单](#7-附录需求清单)

---

## 2. 业务模块概览

### 2.1 业务流程总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           承兑业务完整流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
  │  模块一       │     │  模块二       │     │  模块三       │     │  模块四       │
  │  商户入网     │ ──> │  租户配置     │ ──> │  交易处理     │ ──> │  对账清算     │
  └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
        │                    │                    │                    │
        ▼                    ▼                    ▼                    ▼
  - 商户创建           - 费率配置           - 充币/承兑         - 交易对账
  - SP能力开通         - SP能力配置         - 承兑处理           - 费用结算
  - KYC/KYB审核        - 出款规则配置       - 法币出款           - 账单生成
                                            - 退款处理
```

### 2.2 核心角色与交互逻辑

> **核心逻辑**：
>
> - **SP提供产品**：BB、IPL作为服务提供商，提供底层支付能力（产品）
> - **TP代理产品**：租户签约SP后，代理SP的产品，可以看到SP
> - **MP使用产品**：商户只使用产品，**无需感知SP的存在**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         角色与产品关系                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          SP层（提供产品）                                │
  │                                                                         │
  │   ┌─────────────────────┐         ┌─────────────────────┐              │
  │   │  BB (SP)            │         │  IPL (SP)           │              │
  │   │                     │         │                     │              │
  │   │  提供产品：          │         │  提供产品：          │              │
  │   │  - 数币承兑服务      │         │  - VA收款服务        │              │
  │   │  - 法币出款服务      │         │  - POBO出款服务      │              │
  │   └─────────────────────┘         └─────────────────────┘              │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ TP签约SP，代理产品
                                    │ TP能看到SP
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          TP层（代理产品）                                │
  │                                                                         │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │  租户(TP) - 如：环球、TC、WB、FOPAY                              │   │
  │   │                                                                 │   │
  │   │  - 签约SP，获得产品代理权                                        │   │
  │   │  - 为商户开通产品                                                │   │
  │   │  - 配置商户费率                                                  │   │
  │   │  - 配置产品路由规则                                              │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ TP给MP开通产品
                                    │ MP只看到产品，不感知SP
                                    ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          MP层（使用产品）                                │
  │                                                                         │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │  商户(MP)                                                       │   │
  │   │                                                                 │   │
  │   │  看到的产品（不感知SP）：                                         │   │
  │   │  - 数币钱包（充币/提币）                                          │   │
  │   │  - 承兑服务（onramp/offramp）                                      │   │
  │   │  - 法币账户（充值/提现）                                          │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 产品与SP对应关系

> **法币账户和数币钱包是独立产品**，开通即自带充值/提现、充币/提币能力。

| 签约SP | 产品（独立产品）                         | 产品说明                     | 开通即自带能力                        |
| ------ | ---------------------------------------- | ---------------------------- | ------------------------------------- |
| BB     | **数币钱包**                       | 数币资产管理(USDT/USDC)      | 充币（链上入金）、提币（链上出金）    |
| BB     | **BB法币账户**                     | BB侧法币资金管理             | 充值（BB代收付账户同名充值）、提现        |
| IPL    | **IPL法币账户**                    | IPL侧法币资金管理            | 充值（VA同名充值，贸易背景）、提现    |
| BB     | **承兑产品**（On/Off-Ramp）        | USDT/USDC → USD承兑       | 依赖数币钱包+至少1个法币账户(IPL/BB)  |

> **说明**：
>
> - **商户只选择承兑产品**，BB数币钱包 + BB法币账户**默认开通**（推送BB审核）
> - 商户可选是否额外使用**IPL法币账户**（选了才推送IPL审核）
> - **审核独立**：BB过了就能用BB，IPL过了就能用IPL，互不依赖
> - 承兑本期仅支持 USDT/USDC → USD
> - VA收款是IPL法币账户的充值方式，不是独立产品
> - 付款（POBO）是单独的产品，不在承兑产品范围内

### 2.4 三种业务场景

| 场景            | 商户使用的产品                   | TP签约的SP | 说明                        |
| --------------- | -------------------------------- | ---------- | --------------------------- |
| **场景A** | 数币钱包 + 承兑服务              | BB         | BB内部处理，商户不感知      |
| **场景B** | 数币钱包 + 承兑服务 + 付款(POBO) | BB + IPL   | BB承兑，IPL出款，商户不感知 |
| **场景C** | 收款(VA) + 付款(POBO)            | IPL        | 纯法币业务，商户不感知      |

### 2.5 MVP简化方案

> **核心决策**：MVP阶段只支持IPL+BB，**账户按SP区分**（BB账户余额、IPL账户余额独立）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MVP账户模型（按SP区分）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【商户视角】                                                                │
│  ┌──────────────────────────┐  ┌──────────────────────────┐               │
│  │  BB账户                   │  │  IPL账户                  │               │
│  │  USDT钱包：5,000 USDT    │  │  USD法币账户：$3,000      │               │
│  │  USD法币账户：$7,000      │  │                           │               │
│  └──────────────────────────┘  └──────────────────────────┘               │
│                                                                             │
│  【核心规则】                                                                │
│  - 每个SP给商户开独立账户，余额分开展示                                       │
│  - BB有BB的余额，IPL有IPL的余额                                              │
│  - 承兑后资金落入对应SP账户（模式一：落入IPL账户）                              │
│  - IPL↔BB可定期调拨平账                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**MVP范围说明**：

| 项目     | MVP支持                                      | 后续扩展           |
| -------- | -------------------------------------------- | ------------------ |
| SP范围   | IPL + BB                                     | YPay、ZPay等独立SP |
| 账户模型 | 按SP区分账户（BB账户余额、IPL账户余额独立） | 独立SP各自账户     |
| 资金调拨 | IPL↔BB定期调拨                              | 独立SP不可调拨     |

### 2.6 "数法融合"定位

> **"数法融合"是解决方案/营销层面的概念，不是商户可见的产品**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         "数法融合"定位                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【对外/营销层面】                                                           │
│  "数法融合"是解决方案的名称，强调数币+法币的融合能力                           │
│                                                                             │
│  【TP层面】                                                                  │
│  TP签约了BB+IPL，就具备"数法融合"能力                                        │
│  TP可以为商户配置使用BB的能力、IPL的能力、或两者组合                          │
│                                                                             │
│  【商户层面】                                                                │
│  商户不感知"数法融合"，只看到具体产品：                                       │
│  - 数币钱包、法币账户、承兑服务（BB提供）                                     │
│  - VA收款、付款（IPL提供）                                                   │
│  商户开通产品后，TP通过路由决定用哪个SP处理                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块一：商户入网与产品开通

### 3.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        商户入网与产品开通模块                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   商户创建       │  │   产品开通       │  │   产品路由配置   │             │
│  │                 │  │                 │  │                 │             │
│  │  - 基本信息录入  │  │  - 选择产品     │  │  - 默认路由规则  │             │
│  │  - KYC/KYB材料  │  │  - 后台SP入网   │  │  - 商户级路由    │             │
│  │  - 业务类型     │  │  - 审核通过     │  │  - 优先级配置    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
│  【核心原则】                                                                │
│  - TP签约SP，代理产品                                                        │
│  - TP给商户开通产品（商户只看到产品名称，不感知SP）                             │
│  - TP配置产品路由规则（决定用哪个SP处理）                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 TP签约SP流程

> **说明**：租户需先与SP签约，获得产品代理权，才能为商户开通对应产品。

```
┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  SP(BB)  │
└────┬─────┘                    └────┬─────┘
     │                               │
     │ 1. 申请签约                    │
     │──────────────────────────────>│
     │                               │
     │                               │ 2. 审核租户资质
     │                               │──┐
     │                               │<─┘
     │                               │
     │ 3. 签约完成                    │
     │    获得产品代理权              │
     │<──────────────────────────────│
     │                               │
     │ 4. 产品列表更新                │
     │    可为商户开通：              │
     │    - 法币收款  
          - 充币                │
     │    - 承兑服务                  │
     │    - 提币
          - 法币出款                  │
     │                              │
```

**TP签约后获得的产品代理权**：

| 签约SP | 产品                           | 产品说明            | 能力/方式          |
| ------ | ------------------------------ | ------------------- | ------------------ |
| BB     | 数币钱包（充币，提币）         | 接收USDT/USDC等数币 | 充币、提币         |
| BB     | 法币账户（法币充值，法币提现） | 法币资金管理        | 充值、提现         |
| BB     | 数币钱包（提币，提现）         | 数币提取            | 提币、提现         |
| BB     | 承兑服务                       | 法币付款到银行账户  | 数币→法币         |
| IPL    | 法币账户（提现）               | 法币资金管理        | 提现               |
| IPL    | 收款                           | 法币VA账户收款      | VA收款（收款方式） |
| IPL    | 付款                           | 法币代付出款+POBO   | POBO（付款能力）   |

### 3.3 商户入网流程（产品驱动）

> **核心逻辑**：
>
> - 商户注册后**先选择产品**，提交产品开通申请（含KYC/KYB资料）
> - 系统根据产品→SP映射，**自动推送到对应SP审核**
> - SP审核通过后，通知商户**产品已开通**
> - **EX不做合规审核**，审核由SP负责；TP无需先审核入网
> - 商户全程不感知SP的存在

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ 商户(MP) │                    │ EX系统   │                    │  SP层    │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │ 1. 注册（基本信息）            │                               │
     │──────────────────────────────>│                               │
     │                               │                               │
     │                               │ 2. 创建MID                    │
     │                               │    状态: REGISTERED            │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │ 3. 注册成功，进入产品选择       │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
     │ 4. 选择产品 + 提交KYC资料      │                               │
     │    (数币钱包/承兑/收款等)      │                               │
     │──────────────────────────────>│                               │
     │                               │                               │
     │                               │ 5. 校验资料完整性              │
     │                               │    查询产品→SP映射             │
     │                               │    自动推送到对应SP             │
     │                               │──────────────────────────────>│
     │                               │                               │
     │                               │                               │ 6. SP审核
     │                               │                               │   (KYC/KYB/
     │                               │                               │    合规/风控)
     │                               │                               │──┐
     │                               │                               │<─┘
     │                               │                               │
     │                               │ 7. SP审核结果                  │
     │                               │<──────────────────────────────│
     │                               │                               │
     │ 8. 通知：产品开通成功           │                               │
     │    (商户可以使用产品了)        │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
```

> **与旧设计的区别**：去掉了"TP先审核入网→再选产品"的两阶段模式。现在是**注册即创建MID → 选产品 → 推送SP审核**，一步到位。EX是科技平台，不做合规审核。

### 3.4 商户选择产品与开通流程

#### 3.4.1 三种产品开通方式

> **产品开通支持三种方式**：商户主动开通、自动开通、TP开通

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         产品开通方式                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【方式一】商户主动开通                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  商户入网通过后，在MP中主动选择需要开通的产品                          │   │
│  │  适用：商户清楚自己的业务需求                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【方式二】自动开通（根据商户资料）                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据商户入网时填写的业务类型、资质材料，系统自动推荐/开通产品          │   │
│  │  适用：标准化业务场景                                                  │   │
│  │                                                                       │   │
│  │  自动开通规则示例：                                                    │   │
│  │  - 业务类型=跨境电商 → 自动开通：数币钱包+承兑产品+法币账户             │   │
│  │  - 业务类型=贸易结算 → 自动开通：IPL法币账户                          │   │
│  │  - 有数币钱包地址 → 自动开通：数币钱包                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【方式三】TP开通                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  租户在TP后台为商户开通产品                                            │   │
│  │  适用：TP统一管理商户产品配置                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**三种开通方式对比**：

| 开通方式               | 触发者   | 触发时机                     | 适用场景         |
| ---------------------- | -------- | ---------------------------- | ---------------- |
| **商户主动开通** | 商户(MP) | 注册后，商户在MP选择产品     | 商户清楚业务需求 |
| **自动开通**     | 系统     | 注册时，根据商户资料自动开通 | 标准化业务场景   |
| **TP开通**       | 租户(TP) | TP在后台为商户配置产品       | TP统一管理       |

#### 3.4.2 产品驱动流程说明

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     商户注册与产品开通（产品驱动，一步到位）                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌───────────────┐
  │ 1. 商户注册    │  填写基本信息（公司名称、联系人、邮箱等）
  │                │  ⚡ 注册即创建MID，无需等待审核
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 2. 选择产品    │  三种方式任选其一：
  │    + 提交资料  │  - 商户主动选择产品
  │                │  - 系统根据资料自动开通
  │                │  - TP在后台为商户开通
  │                │  同时提交KYC/KYB资料
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 3. 系统自动    │  根据产品→SP映射，自动向对应SP推送入网申请
  │    推送SP      │  （商户不感知此步骤）
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 4. SP审核     │  SP负责KYC/KYB/合规/风控审核
  │                │  EX不做合规审核
  └───────┬───────┘
          │
          ▼
  ┌───────────────┐
  │ 5. 产品开通    │  ★ 通知商户：产品已开通
  │    通知商户    │    商户可以使用产品了
  └───────────────┘
```

#### 3.4.2 商户视角的通知

| 通知                   | 触发时机           | 通知内容                            | 商户可操作 |
| ---------------------- | ------------------ | ----------------------------------- | ---------- |
| **产品开通通知** | SP审核产品开通通过 | "产品已开通：数币钱包、承兑服务..." | 使用产品   |

> **说明**：不再有"入网审核通过"的独立通知。商户注册后直接选产品，SP审核通过即产品开通，只有一次通知。

#### 3.4.3 商户选择产品界面（示意）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           选择开通产品                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  注册成功！请选择需要开通的产品：                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  【BB产品】                                                         │   │
│  │  ☑ 数币钱包（充币，提币）                                            │   │
│  │     接收USDT/USDC等数字货币                                          │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☑ 法币账户（法币充值，法币提现）                                     │   │
│  │     法币资金管理                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☑ 承兑服务                                                         │   │
│  │     数字货币兑换为法币，付款到银行账户                                 │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  【IPL产品】                                                        │   │
│  │  ☐ 法币账户（提现）                                                  │   │
│  │     法币资金管理                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☐ 收款                                                             │   │
│  │     法币VA账户收款                                                   │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ☐ 付款                                                             │   │
│  │     法币代付出款+POBO                                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│                              [ 提交申请 ]                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.4.4 产品与SP入网映射

| 商户开通的产品         | 系统自动触发的SP入网 | 说明                  |
| ---------------------- | -------------------- | --------------------- |
| 数币钱包（充币，提币） | BB入网               | 需要BB的数币钱包能力  |
| 法币账户（BB）         | BB入网               | 需要BB的法币账户能力  |
| 数币钱包（提币，提现） | BB入网               | 需要BB的数币钱包能力  |
| 承兑服务               | BB入网               | 需要BB的承兑引擎      |
| 法币账户（IPL）        | IPL入网              | 需要IPL的法币账户能力 |
| 收款                   | IPL入网              | 需要IPL的VA收款能力   |
| 付款                   | IPL入网              | 需要IPL的POBO能力     |

#### 3.4.5 商户视角 vs TP视角

| 视角               | 看到的内容                       | 操作权限 |
| ------------------ | -------------------------------- | -------- |
| **商户(MP)** | 产品名称（数币钱包、承兑产品、法币账户等） | 使用产品 |
| **租户(TP)** | 产品名称 + 底层SP                | 开通产品 |

### 3.5 产品路由配置 ⛔ 本期不实现

> **本期不需要路由配置**：每个产品只对应唯一一个SP（BB=承兑+数币钱包，IPL=法币收款+法币账户），不存在多SP提供同一产品的场景，交易直接走产品对应的SP，无需路由选择。
>
> 后续如果出现多SP提供同一产品的场景，再启用路由配置功能。详见 [onborading.md - Phase 1 能力范围](onborading.md)。

## 4. 模块二：租户配置

### 4.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           租户配置模块                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   费率配置       │  │   SP能力配置    │  │   出款规则配置   │             │
│  │                 │  │                 │  │                 │             │
│  │  - 商户费率      │  │  - 收款能力     │  │  - 异名出款规则  │             │
│  │  - 费率类型      │  │  - 出款能力     │  │  - 错名出款规则  │             │
│  │  - 扣费方式      │  │  - 默认SP选择   │  │  - 限额配置      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 费率配置流程

```
┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  SP(BB)  │
└────┬─────┘                    └────┬─────┘
     │                               │
     │ 1. 查询SP底价                  │
     │──────────────────────────────>│
     │                               │
     │ 2. 返回底价信息                │
     │<──────────────────────────────│
     │                               │
     │ 3. 配置商户费率                │
     │    (不得低于底价)              │
     │──────────────────────────────>│
     │                               │
     │                               │ 4. 费率校验
     │                               │──┐
     │                               │  │
     │                               │<─┘
     │                               │
     │ 5. 配置结果通知                │
     │<──────────────────────────────│
     │                               │
```

### 4.3 费率层级结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              费率层级                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ① SP成本价 (SP Cost Price)                                        │   │
│   │  - SP提供给TP的结算价格                                              │   │
│   │  - SP与TP之间可能是返点模式（SP给TP返点/佣金）                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ② SP商户最低报价 (SP Merchant Floor Price) ⭐ 新增                 │   │
│   │  - SP设定的商户最终费率下限，由SP配置，TP不可修改                      │   │
│   │  - 无论SP与TP之间是什么合作模式（返点/加价），                        │   │
│   │    TP给商户配置的费率都不能低于此价格                                  │   │
│   │  - 目的：保护SP的定价底线，防止TP恶性低价竞争                         │   │
│   │                                                                     │   │
│   │  示例：                                                              │   │
│   │  - SP成本价 = 1.0%（SP与TP的结算价）                                 │   │
│   │  - SP返点给TP = 0.3%（SP给TP的佣金）                                 │   │
│   │  - SP商户最低报价 = 1.2%（商户费率不能低于此值）                      │   │
│   │  → TP给商户报价必须 ≥ 1.2%，即使SP与TP之间是返点模式                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ③ 租户费率 (TP Price)                                              │   │
│   │  - TP在SP商户最低报价基础上定价                                       │   │
│   │  - 不得低于SP商户最低报价                                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ④ 商户费率 (Merchant Price)                                        │   │
│   │  - TP为商户配置的最终费率                                             │   │
│   │  - 不得低于租户费率                                                   │   │
│   │  - 系统校验：商户费率 ≥ SP商户最低报价                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**SP与TP的两种合作模式：**

| 合作模式           | SP成本价         | SP商户最低报价     | TP利润来源                 | 说明                                 |
| ------------------ | ---------------- | ------------------ | -------------------------- | ------------------------------------ |
| **加价模式** | SP给TP一个底价   | SP设定商户最低报价 | TP在底价上加价，差价即利润 | TP报价 ≥ SP商户最低报价             |
| **返点模式** | SP给TP一个标准价 | SP设定商户最低报价 | SP按交易量返点/佣金给TP    | TP报价 ≥ SP商户最低报价，SP额外返点 |

> **关键约束**：无论哪种合作模式，TP给商户配置的费率都必须 ≥ SP商户最低报价。系统在TP配置商户费率时自动校验。

### 4.4 费率类型与扣费方式

**费率类型**：

| 类型       | 说明                 | 示例                      |
| ---------- | -------------------- | ------------------------- |
| 百分比费率 | 按交易金额百分比收取 | 1.5%                      |
| 固定费用   | 每笔交易固定金额     | 5 USD/笔                  |
| 阶梯费率   | 按交易量分段计费     | 0-10万: 1.5%, 10万+: 1.2% |
| 混合费率   | 百分比+固定费用      | 1% + 2 USD                |

**扣费方式**：

| 方式           | 说明             | 计算示例                     | 特殊说明                                                           |
| -------------- | ---------------- | ---------------------------- | ------------------------------------------------------------------ |
| **内扣** | 从交易金额中扣除 | 交易1000，费率1%，实收990    | 收款：收款都是内扣                                                 |
| 外扣           | 从账户余额中扣除 | 交易1000，实收1000，账户扣10 | 付款：保证到账金额都是外扣<br />不保证到账金额，可以内扣，可以外扣 |

### 4.5 SP能力配置

租户为商户配置使用哪个SP的能力：

| 配置项   | 可选值            | 说明                       |
| -------- | ----------------- | -------------------------- |
| 充值能力 | BB代收付账户 / IPL VA | 选择BB充值还是IPL VA充值 |
| 出款能力 | BB出款 / IPL POBO | 选择BB出款还是IPL代付      |

> **注意**：BB内部使用代收付账户还是XPAY渠道，由BB内部决定，对租户透明。

### 4.6 出款规则配置

| 规则       | 说明                 | 配置项                 |
| ---------- | -------------------- | ---------------------- |
| 异名出款   | 出款人与收款人不同名 | 是否允许、是否需审核   |
| 错名出款   | 收款人名称有差异     | 容忍度阈值、是否需审核 |
| 单笔限额   | 单笔交易限额         | 最小/最大金额          |
| 日累计限额 | 日累计交易限额       | 最大累计金额           |

## 5. 模块三：交易处理

> 交易流程的完整设计请参见 [transaction.md](transaction.md)，包括3单模型、交易类型分类、业务侧定义与交易引擎、各交易类型详细流程、承兑模式、状态机设计等。

---

## 6. 模块四：对账清算

### 6.1 模块结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           对账清算模块                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   交易对账       │  │   费用结算       │  │   账单生成       │             │
│  │                 │  │                 │  │                 │             │
│  │  - 数据核对      │  │  - 费用计算     │  │  - 商户账单      │             │
│  │  - 差异处理      │  │  - 分润结算     │  │  - 租户账单      │             │
│  │  - 对账报告      │  │  - 结算周期     │  │  - 账单下载      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 对账流程

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ 租户(TP) │                    │  BB(SP)  │                    │  IPL(SP) │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │                               │ 1. 日终对账任务               │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │                               │ 2. 获取IPL交易数据            │
     │                               │──────────────────────────────>│
     │                               │                               │
     │                               │ 3. 返回交易数据               │
     │                               │<──────────────────────────────│
     │                               │                               │
     │                               │ 4. 数据核对                   │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │                               │ 5. 生成对账报告               │
     │                               │──┐                            │
     │                               │<─┘                            │
     │                               │                               │
     │ 6. 推送对账结果               │                               │
     │<──────────────────────────────│                               │
     │                               │                               │
```

### 6.3 费用分润模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              费用分润                                        │
└─────────────────────────────────────────────────────────────────────────────┘

  商户支付总费用 = 100 USD
       │
       ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                      费用拆分                               │
  │                                                             │
  │   ┌───────────────┐   ┌───────────────┐                    │
  │   │   SP成本       │   │   租户利润     │                    │
  │   │  (BB+IPL底价)  │   │  (租户加价)    │                    │
  │   │   70 USD       │   │   30 USD       │                    │
  │   └───────────────┘   └───────────────┘                    │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘
```

---

## 7. 附录：需求清单

| 序号 | 需求描述              | 优先级 | 对应模块          |
| ---- | --------------------- | ------ | ----------------- |
| 1    | 租户可以看到交易      | P1     | 模块三-交易查询   |
| 2    | 租户可以配置商户费率  | P0     | 模块二-费率配置   |
| 3    | 交易收费-支持内扣     | P0     | 模块二-扣费方式   |
| 4    | 支持异名出款          | P0     | 模块三-法币出款   |
| 5    | 支持本地出款          | P0     | 模块三-法币出款   |
| 6    | 支持错名出款          | P1     | 模块三-法币出款   |
| 7    | 产品开通补充字段      | P2     | 模块一-商户入网   |
| 8    | 退款流程              | P1     | 模块三-退款处理   |
| 9    | 收款/出款渠道灵活配置 | P2     | 模块二-SP能力配置 |

---

*文档版本：v2.0*
*创建日期：2026-01-31*
*最后更新：2026-01-31*
